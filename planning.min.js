!function(){"use strict";angular.module("90Tech.planning",["pikaday"])}(),function(){"use strict";function ScrollHorizontalDirective($timeout){return{restrict:"A",scope:{scrollLeft:"="},link:function(scope,element,attributes){element.bind("mousewheel",function(e){element[0].scrollLeft-=e.wheelDelta/3}),element.addClass("slider"),scope.scrollLeft,$timeout(function(){element[0].scrollLeft=scope.scrollLeft-element[0].offsetWidth/2},100)}}}angular.module("90Tech.planning").directive("zlHorizontalScroll",ScrollHorizontalDirective),ScrollHorizontalDirective.$inject=["$timeout"]}(),function(){"use strict";function PlanningLeftColumnController($scope){function init(){self.days=[],"week"===self.mode?_.times(7,function(i){var d=moment(self.position);d.weekday(i),self.days.push(d)}):"day"===self.mode&&self.dayField&&(self.column=_.keys(self.events))}var self=this;$scope.$watchCollection(function(){return[self.events,self.position,self.mode,self.dayStart,self.dayEnd]},init)}function PlanningDirective(){return{restrict:"E",templateUrl:"planning/directives/planning-left-column/planning-left-column.html",controller:PlanningLeftColumnController,controllerAs:"planningLeftColumn",bindToController:{events:"=",position:"=",mode:"=",dayField:"="},scope:!0}}angular.module("90Tech.planning").directive("zlPlanningLeftColumn",PlanningDirective),PlanningLeftColumnController.$inject=["$scope"]}(),function(){"use strict";function PlanningLineController($scope,planningConfiguration){function clickEvent(hour,$event){if(_.contains($event.target.classList,"half-hour"))var minutes=30;else var minutes=Math.floor($event.offsetX/(BASE_SIZE*self.zoom)*60);self.clickCallback({$hour:hour+parseInt(self.dayStart.h),$minutes:minutes})}function init(){self._events=angular.copy(self.events),self.range=self.dayEnd.h-self.dayStart.h,self.SECONDS_BY_DAY=3600*self.range,self.SLIDER_WIDTH=BASE_SIZE*self.range,self._events=_.sortBy(self._events,function(e){return e.start.valueOf()});var lines=[[]];_.each(self._events,function(event){var style={};if(event.depth=1,event.range=moment.range(event.start,event.end),event.range<9e5){console.info("<<");var end=moment(event.start).add(15,"minutes");event.range=moment.range(event.start,end)}style.left=(event.start.hours()-self.dayStart.h)*BASE_SIZE*self.zoom+event.start.minutes()*BASE_SIZE*self.zoom/60+"px",style.width=self.zoom*self.SLIDER_WIDTH*event.range/self.SECONDS_BY_DAY/1e3+"px",style["background-color"]=event["background-color"]||"#778899",event.style=style;line:for(var i=0;i<lines.length;i++){if(!lines[i].length){lines[i].push(event),event.line=i;break line}{if(!_.filter(lines[i],function(elt){return event.range.overlaps(elt.range)?(elt.depth+=1,!0):void 0}).length){lines[i].push(event),event.line=i;break line}event.depth+=1,lines[i+1]||(lines[i+1]=[])}}}),_.each(self._events,function(event,i){event.style.top=Math.round(100*event.line/lines.length)+"%",event.style.height=Math.round(100/lines.length)+"%"})}function calcWidth(zoom){return parseInt(zoom)*BASE_SIZE+"px"}var BASE_SIZE=planningConfiguration.BASE_SIZE,self=this;init(),$scope.$watchCollection(function(){return[self.events,self.dayStart,self.dayEnd]},init),_.extend(self,{clickEvent:clickEvent,calcWidth:calcWidth})}function PlanningLineDirective(){return{restrict:"E",templateUrl:"planning/directives/planning-line/planning-line.html",controller:PlanningLineController,controllerAs:"line",bindToController:{zoom:"=",dayStart:"=",dayEnd:"=",events:"=",clickCallback:"&"},scope:!0}}angular.module("90Tech.planning").directive("zlPlanningLine",PlanningLineDirective),PlanningLineController.$inject=["$scope","planningConfiguration"]}(),function(){"use strict";function topRowDirective(planningConfiguration){function PlanningTopRowController($scope){function init(){var range=self.dayEnd.h-self.dayStart.h+1;self.hours=[],_.times(range,function(i){var d=moment(self.position);d.hour(i+parseInt(self.dayStart.h)),d.minute(0),self.hours.push(d)})}function calcWidth(zoom){return parseInt(zoom)*BASE_SIZE+"px"}function calcMargin(zoom,index){var half=parseInt(zoom)*(BASE_SIZE/2);return index||(half-=3*parseInt(zoom)),"0 "+half+"px 0 -"+half+"px"}var self=this;$scope.$watchGroup([function(){return self.dayStart},function(){return self.dayEnd}],init),_.extend(self,{calcWidth:calcWidth,calcMargin:calcMargin}),init()}var BASE_SIZE=planningConfiguration.BASE_SIZE;return{restrict:"E",templateUrl:"planning/directives/planning-top-row/planning-top-row.html",controller:["$scope",PlanningTopRowController],controllerAs:"planningTopRow",bindToController:{zoom:"=",dayStart:"=",dayEnd:"=",events:"=",entities:"=",position:"=",mode:"=",callback:"&"},scope:{}}}angular.module("90Tech.planning").directive("zlPlanningTopRow",topRowDirective),topRowDirective.$inject=["planningConfiguration"]}(),function(){"use strict";function PlanningController($scope,planningConfiguration){function split(event){event=angular.copy(event);var start=moment(event.start).hour(self._dayStart.h).minute(self._dayStart.m).second(0),stop=moment(event.end).hour(self._dayEnd.h).minute(self._dayEnd.m).second(59);if(event.start.dayOfYear()===event.end.dayOfYear()){if(event.start.isBefore(start)){if(event.end.isBefore(start))return[];event.start=start}if(event.end.isAfter(stop)){if(event.start.isAfter(stop))return[];event.end=stop}return[event]}var first_event=angular.copy(event);first_event.end=moment(event.start).hour(self._dayEnd.h).minute(self._dayEnd.m).second(59),event.start.isBefore(start)&&(first_event.start=start);var startNextDay=moment(event.start).add(1,"day").hour(self._dayStart.h).minute(self._dayStart.m),endThisDay=moment(event.start).hour(self._dayEnd.h).minute(self._dayEnd.m);if(event.end.isBefore(startNextDay))return first_event.start.isAfter(endThisDay)?[]:[first_event];first_event.continuedAfter=!0;var second_event=angular.copy(event);return second_event.start=moment(event.start).add(1,"day").hour(self._dayStart.h).minute(self._dayStart.m),second_event.continuedBefore=!0,event.start.isAfter(endThisDay)?split(second_event):[first_event].concat(split(second_event))}function filter(events){return _.filter(events,function(e){var start,stop;return"week"===self.mode?(start=moment(self.position).weekday(0).hour(self._dayStart.h).minute(self._dayStart.m).second(0),stop=moment(self.position).weekday(7).hour(self._dayEnd.h).minute(self._dayEnd.m).second(59)):"day"===self.mode&&(start=moment(self.position).hour(self._dayStart.h).minute(self._dayStart.m).second(0),stop=moment(self.position).hour(self._dayEnd.h).minute(self._dayEnd.m).second(59)),e.start.isBetween(start,stop)})}function addMissingDays(sortedEvents){sortedEvents=sortedEvents||{};var startingDay=moment(self.position).weekday(0).dayOfYear();_.times(7,function(i){sortedEvents[startingDay+i]||(sortedEvents[startingDay+i]=[])})}function addMissingEntities(sortedEvents){sortedEvents=sortedEvents||{},_.each(self.entities,function(e){sortedEvents[e]||(sortedEvents[e]=[])})}function parseTime(h){return h>=24?{h:23,m:59}:{h:h,m:0}}function init(){self.zoom=parseInt(self.zoom),(!self.zoom||self.zoom<1)&&(self.zoom=1),self._dayStart=parseTime(self.dayStart?self.dayStart:0),self._dayEnd=parseTime(self.dayEnd?self.dayEnd:24),self.width=self.zoom*(parseInt(self._dayEnd.h)-parseInt(self._dayStart.h)+1)*BASE_SIZE+"px",self.sortedEvents=void 0,self._events=_.flatten(_.map(self.events,split)),self._events=filter(self._events),"week"===self.mode?(self.sortedEvents=_.groupBy(self._events,function(e){return e.start.dayOfYear()}),addMissingDays(self.sortedEvents)):"day"===self.mode&&(self.sortedEvents=_.groupBy(self._events,function(e){return e[self.dayField]}),addMissingEntities(self.sortedEvents))}function keys(sortedEvents){return"week"===self.mode?Object.keys(sortedEvents):"day"===self.mode?Object.keys(sortedEvents).sort():void 0}function getEvents(key){return self.sortedEvents[key]}function isToday(n){return self.position.week()===moment().week()&&n==moment().dayOfYear()}function isInDayRange(){return moment().hour()>parseInt(self._dayStart.h)&&moment().hour()<parseInt(self._dayEnd.h)}function currentTimeToPixels(){var totalMinutes=60*(moment().hour()-parseInt(self._dayStart?self._dayStart.h:0))+moment().minutes();return Math.floor(self.zoom*(BASE_SIZE*totalMinutes)/60)}function isCurrent(){return self.position.isSame(moment(),self.mode)}function clickCallbackWrapper(h,m,d){var mom;"week"===self.mode?mom=moment().hour(h).minute(m).second(0).dayOfYear(d):"day"===self.mode&&(mom=moment(self.position).hour(h).minute(m)),self.clickCallback({$moment:mom,$entity:"day"===self.mode?d:void 0})}var BASE_SIZE=planningConfiguration.BASE_SIZE,self=this;init(),$scope.$watchCollection(function(){return[self.events,self.entities,self.position,self.mode,self.dayStart,self.dayEnd,self.zoom]},init),_.extend(self,{isToday:isToday,currentTimeToPixels:currentTimeToPixels,isCurrent:isCurrent,clickCallbackWrapper:clickCallbackWrapper,isInDayRange:isInDayRange,keys:keys,getEvents:getEvents})}function PlanningDirective(){return{restrict:"E",templateUrl:"planning/directives/planning/planning.html",controller:PlanningController,controllerAs:"planning",bindToController:{zoom:"=",events:"=",entities:"=",position:"=",mode:"=",dayStart:"=",dayEnd:"=",dayField:"=",eventCallback:"&",dayCallback:"&",clickCallback:"&"},scope:{}}}angular.module("90Tech.planning").directive("zlPlanning",PlanningDirective),PlanningController.$inject=["$scope","planningConfiguration"]}(),function(){"use strict";angular.module("90Tech.planning").filter("format",function(){return function(time,format){return time.format(format)}}).filter("capitalize",function(){return function(str){return str.charAt(0).toUpperCase()+str.slice(1)}})}(),function(){"use strict";function RangeFilter(){var operation=function(input,total){total=parseInt(total);for(var i=0;total>i;i++)input.push(i);return input};return operation}angular.module("90Tech.planning").filter("range",RangeFilter)}(),function(){"use strict";angular.module("90Tech.planning").filter("strPlanning",["planningConfiguration",function(planningConfiguration){return function(val){return planningConfiguration.strings[val]}}])}(),angular.module("90Tech.planning").provider("planningConfiguration",function(){var self=this;self.BASE_SIZE=10,self.strings={nothing_to_show:"Rien à afficher"},this.setBaseSize=function(size){self.BASE_SIZE=size},this.setString=function(key,value){self.strings[key]=value},this.$get=[function(){return{strings:self.strings,BASE_SIZE:self.BASE_SIZE}}]}),angular.module("90Tech.planning").run(["$templateCache",function($templateCache){"use strict";$templateCache.put("planning/directives/planning-left-column/planning-left-column.html",'<div class="left-column" ng-switch="planningLeftColumn.mode">\r\n    <div class="planning-head"></div>\r\n    <div class="left-body">\r\n    <div class="planning-2pc"></div>\r\n        <div class="days-body" ng-switch-when="week">\r\n            <div class="dayName row8 b-b animate"\r\n                 ng-repeat="day in planningLeftColumn.days"\r\n                    ng-class="{today: planning.isToday(day.dayOfYear())}"\r\n                    ng-click="planning.dayCallback({$day:day})">\r\n                <h4>\r\n                    {{day | format:\'dddd\' | capitalize}}<br>\r\n                    <small>{{day | format:\'ll\'}}</small>\r\n                </h4>\r\n            </div>\r\n        </div>\r\n        <div class="days-body" ng-switch-when="day">\r\n            <div class="dayName row8 b-b animate"\r\n                 ng-repeat="col in planningLeftColumn.column | orderBy:col">\r\n                <h4>\r\n                    {{col}}\r\n                </h4>\r\n            </div>\r\n        </div>\r\n    </div>\r\n    <div style="height:10px"><!-- compensate for scrollbar --></div>\r\n</div>'),$templateCache.put("planning/directives/planning-line/planning-line.html",'<div class="b-b b-r all-day day-hour"\r\n     ng-style="{width: line.calcWidth(line.zoom)}"\r\n     ng-repeat="n in [] | range:line.range"\r\n     ng-dblclick="line.clickEvent(n, $event)">\r\n    <span class="half-hour"></span>\r\n\r\n</div>\r\n\r\n<div class="event"\r\n     ng-repeat="event in line._events"\r\n     ng-style="event.style"\r\n     ng-class="{\'continued-before\': event.continuedBefore, \'continued-after\': event.continuedAfter}"\r\n     ng-click="planning.eventCallback({\'event\':event})"\r\n     tooltip-append-to-body="true"\r\n     uib-tooltip="{{event.tooltip}}">\r\n    <!--<span class="calendar-urgency bg-pink"></span>-->\r\n\r\n    <div class="event-line-container" style="">\r\n        <div class="event-line" ng-style="{\'background-color\': event.color}" ng-if="!event.continuedBefore"></div>\r\n    </div>\r\n\r\n    <div class="title-container"><span>{{event.title}}</span></div>\r\n</div>'),$templateCache.put("planning/directives/planning-top-row/planning-top-row.html",'<div class="planning-top-row">\r\n    <div ng-repeat="hour in planningTopRow.hours" class="day-hour"\r\n         ng-style="{width: planningTopRow.calcWidth(planningTopRow.zoom), margin: planningTopRow.calcMargin(planningTopRow.zoom, $index)}">\r\n        <h4>{{hour | format:\'HH:mm\'}}</h4>\r\n    </div>\r\n</div>\r\n\r\n'),$templateCache.put("planning/directives/planning/planning.html",'<zl-planning-left-column mode="planning.mode" position="planning.position" day-field="planning.dayField"\r\n                         events="planning.sortedEvents"></zl-planning-left-column>\r\n<div class="" style="height:100%">\r\n    <div zl-horizontal-scroll scroll-left="planning.currentTimeToPixels()" style="height:100%">\r\n        <div ng-style="{width: planning.width}" class="planning-body">\r\n            <zl-planning-top-row mode="planning.mode" zoom="planning.zoom" position="planning.position"\r\n                                 day-start="planning._dayStart" day-end="planning._dayEnd"></zl-planning-top-row>\r\n            <div class="hour-cursor" ng-style="{left: planning.currentTimeToPixels()+\'px\'}"\r\n                 ng-if="planning.isCurrent() && planning.isInDayRange()">\r\n                <div class="hour-caret"></div>\r\n            </div>\r\n            <div class="planning-2pc"></div>\r\n            <div ng-if="!planning.events.length" style="position:fixed;left:50%;margin:auto">{{\'nothing_to_show\' |\r\n                strPlanning}}\r\n            </div>\r\n            <zl-planning-line\r\n                    zoom="planning.zoom"\r\n                    day-start="planning._dayStart" day-end="planning._dayEnd"\r\n                    ng-repeat="i in planning.keys(planning.sortedEvents)" class="day b-b"\r\n                    ng-class="{today: planning.isToday(i)}" events="planning.getEvents(i)"\r\n                    click-callback="planning.clickCallbackWrapper($hour, $minutes, i)"></zl-planning-line>\r\n        </div>\r\n    </div>\r\n</div>')}]);