!function(angular){"use strict";angular.module("90Tech.planning",["pikaday"])}(window.angular),function(angular){"use strict";angular.module("90Tech.planning").directive("zlPlanningDragDrop",function(){return{controller:function(){},scope:{},controllerAs:"dragDropCtrl",bindToController:{zlDrag:"=",zlDrop:"&"},link:function(scope,element){var dragImage=document.createElement("div"),el=element[0];window.addEventListener("dragover",function(e){e.preventDefault()},!1),window.addEventListener("drop",function(e){e.preventDefault()},!1),el.attributes["zl-drag"]&&(el.draggable=!0,el.addEventListener("dragstart",function(e){return dragImage.style.height=el.clientHeight+"px",dragImage.style.zIndex="1000",dragImage.style.position="relative",dragImage.style.left="-10000px",dragImage.style.bottom="-10000px;",dragImage.innerHTML=el.innerHTML,el.children.length>1?(dragImage.children[0].style["float"]="left",dragImage.style.backgroundColor=el.children[1].style.backgroundColor,dragImage.style.width=el.clientWidth+"px"):(dragImage.style.width=Math.min(el.clientWidth,200)+"px",dragImage.style.backgroundColor=el.children[0].style.backgroundColor),e.dataTransfer.effectAllowed="move",document.body.appendChild(dragImage),e.dataTransfer.setDragImage&&e.dataTransfer.setDragImage(dragImage,0,0),e.dataTransfer.setData("Text",JSON.stringify(scope.dragDropCtrl.zlDrag)),this.classList.add("drag"),!1},!1),el.addEventListener("dragend",function(e){return dragImage.remove(),this.classList.remove("drag"),!1},!1)),el.attributes["zl-drop"]&&(el.addEventListener("drop",function(e){return e.preventDefault(),e.stopPropagation(),e.stopPropagation&&e.stopPropagation(),e.target.classList.remove("over"),this.classList.remove("over"),scope.$apply(function(){scope.dragDropCtrl.zlDrop({$data:JSON.parse(e.dataTransfer.getData("Text")),$event:e})}),!1},!1),el.addEventListener("dragenter",function(e){return e.target.classList.add("over"),!1},!1),el.addEventListener("dragleave",function(e){return e.target.classList.remove("over"),!1},!1))}}})}(window.angular),function(angular){"use strict";function ScrollHorizontalDirective($timeout){return{restrict:"A",scope:{scrollLeft:"="},link:function(scope,element,attributes){element.bind("mousewheel",function(e){element[0].scrollLeft-=e.wheelDelta/3}),element.addClass("slider"),scope.scrollLeft,$timeout(function(){element[0].scrollLeft=scope.scrollLeft-element[0].offsetWidth/2},100)}}}angular.module("90Tech.planning").directive("zlHorizontalScroll",ScrollHorizontalDirective),ScrollHorizontalDirective.$inject=["$timeout"]}(window.angular),function(angular,_){"use strict";function PlanningDayController(){function init(){}function dropEvent(data,event){self.dropCallback({$data:data,$event:event})}var self=this;self.isDefined=void 0===self.day.events,init(),_.extend(self,{dropEvent:dropEvent})}function PlanningDayDirective(){return{restrict:"E",replace:!0,templateUrl:"planning/directives/planning-day-block/planning-day.html",controller:PlanningDayController,controllerAs:"dayCtrl",bindToController:{day:"=",events:"=",clickCallback:"&",dropCallback:"&"},scope:!0,link:function(scope,element){var el=element[0];window.addEventListener("dragover",function(e){e.preventDefault()},!1),window.addEventListener("drop",function(e){e.preventDefault()},!1),el.addEventListener("drop",function(e){return e.preventDefault(),e.stopPropagation(),e.stopPropagation&&e.stopPropagation(),this.classList.remove("over"),scope.$apply(function(){scope.dayCtrl.dropEvent(JSON.parse(e.dataTransfer.getData("Text")),e)}),!1},!1),el.addEventListener("dragenter",function(e){return this.classList.add("over"),!1},!1),el.addEventListener("dragleave",function(e){return this.classList.remove("over"),!1},!1)}}}angular.module("90Tech.planning").directive("zlPlanningDay",PlanningDayDirective)}(window.angular,window._),function(angular,moment,_){"use strict";function PlanningLeftColumnController($scope){function init(){self.days=[],"week"===self.mode?_.times(7,function(i){var d=moment(self.position);d.weekday(i),self.days.push(d)}):"day"===self.mode&&self.dayField&&(self.column=Object.keys(self.events).sort())}var self=this;$scope.$watchCollection(function(){return[self.events,self.position,self.mode,self.dayStart,self.dayEnd]},init)}function PlanningDirective(){return{restrict:"E",templateUrl:"planning/directives/planning-left-column/planning-left-column.html",controller:PlanningLeftColumnController,controllerAs:"planningLeftColumn",bindToController:{events:"=",position:"=",mode:"=",dayField:"="},scope:!0}}angular.module("90Tech.planning").directive("zlPlanningLeftColumn",PlanningDirective),PlanningLeftColumnController.$inject=["$scope"]}(window.angular,window.moment,window._),function(angular,_,moment){"use strict";function PlanningLineController($scope,planningConfiguration,PositionService,ColorService){function extractMinutesFromEvent($event){var minutes;return minutes=_.contains($event.target.classList,"half-hour")?30:Math.floor($event.offsetX/(BASE_SIZE*self.zoom)*60)}function dropEvent(data,event){var hour=parseInt(event.target.getAttribute("hour")),minutes=extractMinutesFromEvent(event);self.dropCallback({$data:data,$event:event,$hour:hour+parseInt(self.dayStart.h),$minutes:minutes})}function clickEvent(hour,$event){var minutes=extractMinutesFromEvent($event);self.clickCallback({$hour:hour+parseInt(self.dayStart.h),$minutes:minutes})}function init(){var currentId=0;self.preEvent={},self._events=angular.copy(self.events),self.range=self.dayEnd.h-self.dayStart.h,self.SECONDS_BY_DAY=3600*self.range,self.SLIDER_WIDTH=BASE_SIZE*self.range,self._events=_.sortBy(self._events,function(e){return e.start.valueOf()});var lines=[[]],toremove=[];_.each(self._events,function(event){var style={};if(event.depth=1,event.range=moment.range(event.start,event.end),event.range<9e5){var end=moment(event.start).add(15,"minutes");event.range=moment.range(event.start,end)}style.left=(event.start.hours()-self.dayStart.h)*BASE_SIZE*self.zoom+event.start.minutes()*BASE_SIZE*self.zoom/60+"px",style.width=self.zoom*self.SLIDER_WIDTH*event.range/self.SECONDS_BY_DAY/1e3+"px",style["background-color"]=event["background-color"]||"#778899",ColorService.getLuminance(style["background-color"])>200?style.color="black":style.color="white",event.style=style,PositionService.overlap(lines,event,MAX_PARALLEL,toremove)}),self._events=_.difference(self._events,toremove),_.each(self._events,function(event){if(event.id=angular.copy(currentId),event.line===MAX_PARALLEL&&(event.style.left=(event.start.hours()-self.dayStart.h)*BASE_SIZE*self.zoom+event.start.minutes()*BASE_SIZE*self.zoom/60+"px",event.style.width=self.zoom*self.SLIDER_WIDTH*event.range.valueOf()/self.SECONDS_BY_DAY/1e3+"px",event.style["background-color"]="#000",event.style["font-weight"]="bold",event.title=event.eventList.length+" "+parallelText,event.tooltip&&(event.tooltip=event.title)),event.style.width=self.zoom*self.SLIDER_WIDTH*event.range.valueOf()/self.SECONDS_BY_DAY/1e3+"px",void 0===event.line&&(event.line=MAX_PARALLEL),event.style.top=Math.round(70*parseInt(event.line)/lines.length)+"%",event.style.height=Math.round(70/lines.length)+"%",event.percentage="100%",event.pre>0){event.style["border-left"]="none";var s=moment(event.start).subtract(event.pre,"minutes");moment(s).isSame(event.start,"day")||(s=moment(event.start).startOf("day"));var e=moment(event.start),r=moment.range(s,e),totalRange=moment.range(s,event.range.end),percentage=r.valueOf()/totalRange.valueOf()*100;event.percentage=100-percentage+"%";var obj={percentage:percentage+"%",style:{left:(moment(s).hours()-self.dayStart.h)*BASE_SIZE*self.zoom+moment(s).minutes()*BASE_SIZE*self.zoom/60+2+"px",width:self.zoom*self.SLIDER_WIDTH*r.valueOf()/self.SECONDS_BY_DAY/1e3+"px",top:event.style.top,height:event.style.height,totalWidth:self.zoom*self.SLIDER_WIDTH*totalRange.valueOf()/self.SECONDS_BY_DAY/1e3+"px","text-align":"center",color:"#fff",background:"repeating-linear-gradient(45deg, "+event["background-color"]+", "+event["background-color"]+" 10px, white 10px, white 20px)","border-top":"1px lightgrey solid","border-bottom":"1px lightgrey solid","border-left":"1px lightgrey solid"},tooltip:"Trajet estimÃ© de "+event.pre+" min"};percentage>0?self.preEvent[event.id]=obj:event.pre=0}currentId++})}function calcWidth(zoom){return parseInt(zoom)*BASE_SIZE+"px"}var BASE_SIZE=planningConfiguration.BASE_SIZE,parallelText=planningConfiguration.parallelText,MAX_PARALLEL=planningConfiguration.MAX_PARALLEL,self=this;self.log=function(a){},self.replace=function(string){return string?string.replace(/([a-zA-Z\ ])\w+/,""):void 0},self.preEvent={},init(),$scope.$watchCollection(function(){return[self.events,self.dayStart,self.dayEnd]},init),_.extend(self,{clickEvent:clickEvent,calcWidth:calcWidth,dropEvent:dropEvent})}function PlanningLineDirective(){return{restrict:"E",templateUrl:"planning/directives/planning-line/planning-line.html",controller:PlanningLineController,controllerAs:"line",bindToController:{zoom:"=",dayStart:"=",dayEnd:"=",events:"=",clickCallback:"&",dropCallback:"&"},scope:!0}}angular.module("90Tech.planning").directive("zlPlanningLine",PlanningLineDirective),PlanningLineController.$inject=["$scope","planningConfiguration","PositionService","ColorService"]}(window.angular,window._,window.moment),function(angular,moment,_){"use strict";function topRowDirective(planningConfiguration){function PlanningTopRowController($scope){function init(){var range=self.dayEnd.h-self.dayStart.h+1;self.hours=[],_.times(range,function(i){var d=moment(self.position);d.hour(i+parseInt(self.dayStart.h)),d.minute(0),self.hours.push(d)})}function calcWidth(zoom){return parseInt(zoom)*BASE_SIZE+"px"}function calcMargin(zoom,index){var half=parseInt(zoom)*(BASE_SIZE/2);return index||(half-=3*parseInt(zoom)),"0 "+half+"px 0 -"+half+"px"}var self=this;$scope.$watchGroup([function(){return self.dayStart},function(){return self.dayEnd}],init),_.extend(self,{calcWidth:calcWidth,calcMargin:calcMargin}),init()}var BASE_SIZE=planningConfiguration.BASE_SIZE;return{restrict:"E",templateUrl:"planning/directives/planning-top-row/planning-top-row.html",controller:["$scope",PlanningTopRowController],controllerAs:"planningTopRow",bindToController:{zoom:"=",dayStart:"=",dayEnd:"=",events:"=",entities:"=",position:"=",mode:"=",callback:"&"},scope:{}}}angular.module("90Tech.planning").directive("zlPlanningTopRow",topRowDirective),topRowDirective.$inject=["planningConfiguration"]}(window.angular,window.moment,window._),function(angular,_,moment){"use strict";function PlanningLineController($scope,planningConfiguration,PositionService,ColorService){function extractMinutesFromEvent($event){var minutes;return minutes=_.contains($event.target.classList,"half-hour")?30:10*Math.floor($event.offsetY/(BASE_SIZE*self.zoom)*6)}function dropEvent(data,event){var hour=parseInt(event.target.getAttribute("hour")),minutes=extractMinutesFromEvent(event);self.dropCallback({$data:data,$event:event,$hour:hour+parseInt(self.dayStart.h),$minutes:minutes})}function clickEvent(hour,$event){var minutes=extractMinutesFromEvent($event);self.clickCallback({$hour:hour+parseInt(self.dayStart.h),$minutes:minutes})}function init(){var currentId=0;self.preEvent={},self._events=angular.copy(self.events),self.range=self.dayEnd.h-self.dayStart.h,self.SECONDS_BY_DAY=3600*self.range,self.SLIDER_WIDTH=BASE_SIZE*self.range,self._events=_.sortBy(self._events,function(e){return e.start.valueOf()});var lines=[[]],toremove=[];_.each(self._events,function(event){var style={};if(event.depth=1,event.range=moment.range(event.start,event.end),event.range<9e5){var end=moment(event.start).add(15,"minutes");event.range=moment.range(event.start,end)}style.left=(event.start.hours()-self.dayStart.h)*BASE_SIZE*self.zoom+event.start.minutes()*BASE_SIZE*self.zoom/60+"px",style.width=self.zoom*self.SLIDER_WIDTH*event.range/self.SECONDS_BY_DAY/1e3+"px",style["background-color"]=event["background-color"]||"#778899",ColorService.getLuminance(style["background-color"])>200?style.color="black":style.color="white",event.style=style,PositionService.overlap(lines,event,MAX_PARALLEL,toremove)}),self._events=_.difference(self._events,toremove),_.each(self._events,function(event){if(event.id=angular.copy(currentId),event.line===MAX_PARALLEL&&(event.style.left=(event.start.hours()-self.dayStart.h)*BASE_SIZE*self.zoom+event.start.minutes()*BASE_SIZE*self.zoom/60+"px",event.style.width=self.zoom*self.SLIDER_WIDTH*event.range.valueOf()/self.SECONDS_BY_DAY/1e3+"px",event.style["background-color"]="#000",event.style["font-weight"]="bold",event.title=event.eventList.length+" "+parallelText,event.tooltip&&(event.tooltip=event.title)),event.style.width=self.zoom*self.SLIDER_WIDTH*event.range.valueOf()/self.SECONDS_BY_DAY/1e3+"px",void 0===event.line&&(event.line=MAX_PARALLEL),event.style.top=Math.round(parseInt(event.line)*AVAILABLE_SPACE/lines.length)+"%",event.style.height=Math.round(AVAILABLE_SPACE/lines.length)+"%",event.percentage="100%",event.continuedBefore&&(event.pre=0),event.pre>0){event.style["border-left"]="none";var s=moment(event.start).subtract(event.pre,"minutes");moment(s).isSame(event.start,"day")||(s=moment(event.start).startOf("day"));var e=moment(event.start),r=moment.range(s,e),totalRange=moment.range(s,event.range.end),percentage=r.valueOf()/totalRange.valueOf()*100;event.percentage=100-percentage+"%";var obj={percentage:percentage+"%",style:{left:(moment(s).hours()-self.dayStart.h)*BASE_SIZE*self.zoom+moment(s).minutes()*BASE_SIZE*self.zoom/60+2+"px",width:self.zoom*self.SLIDER_WIDTH*r.valueOf()/self.SECONDS_BY_DAY/1e3+"px",top:event.style.top,height:event.style.height,totalWidth:self.zoom*self.SLIDER_WIDTH*totalRange.valueOf()/self.SECONDS_BY_DAY/1e3+"px","text-align":"center",color:"#fff",background:"repeating-linear-gradient(45deg, "+event["background-color"]+", "+event["background-color"]+" 10px, white 10px, white 20px)","border-top":"1px lightgrey solid","border-bottom":"1px lightgrey solid","border-left":"1px lightgrey solid"},tooltip:"Trajet estimÃ© de "+event.pre+" min"};percentage>0?self.preEvent[event.id]=obj:event.pre=0}currentId++})}function calcWidth(zoom){return parseInt(zoom)*BASE_SIZE+"px"}var BASE_SIZE=Math.max(planningConfiguration.BASE_SIZE-8,1),parallelText=planningConfiguration.parallelText,MAX_PARALLEL=planningConfiguration.MAX_PARALLEL,AVAILABLE_SPACE=90,self=this;self.log=function(a){},self.replace=function(string){return string?string.replace(/([a-zA-Z\ ])\w+/,""):void 0},self.preEvent={},init(),$scope.$watchCollection(function(){return[self.events,self.dayStart,self.dayEnd]},init),_.extend(self,{clickEvent:clickEvent,calcWidth:calcWidth,dropEvent:dropEvent})}function PlanningLineDirective(){return{restrict:"E",templateUrl:"planning/directives/planning-vertical-line/planning-vertical-line.html",controller:PlanningLineController,controllerAs:"line",bindToController:{zoom:"=",dayStart:"=",dayEnd:"=",events:"=",clickCallback:"&",dropCallback:"&"},scope:!0}}angular.module("90Tech.planning").directive("zlPlanningVerticalLine",PlanningLineDirective),PlanningLineController.$inject=["$scope","planningConfiguration","PositionService","ColorService"]}(window.angular,window._,window.moment),function(angular,moment,_){"use strict";function PlanningLineController($scope,PositionService,planningConfiguration,ColorService){function init(){self.displayedEvents=_(self.events).sortBy(function(event){return event.continuedBefore?-1:event.continuedAfter?0:1}).value(),self.displayedEvents=positioning(self.displayedEvents),self.oneDayEvents=positioning(self.oneDayEvents)}function positioning(eventList){var lines=[[]],toRemove=[];return _.each(eventList,function(event){event.style={},event.depth=1,event.range=moment.range(event.start,event.end),PositionService.overlap(lines,event,MAX_PARALLEL,toRemove,!0)}),eventList=_.difference(eventList,toRemove),_.each(eventList,function(event){setStyle(event,lines.length)}),eventList}function setStyle(event,height){event.style.left=calculateLeft(event),event.style.width=calculateWidth(event),event.style["background-color"]=event["background-color"],ColorService.getLuminance(event.style["background-color"])>200?event.style.color="black":event.style.color="white",event.style.top=Math.ceil(100*event.line/height)+"%",event.style.height=Math.round(100/height)+"%",void 0===event.line&&(event.line=MAX_PARALLEL),event.eventList&&event.eventList.length>1&&(event.style["background-color"]="#000",event.style.color="#FFF",event.style["font-weight"]="bold",event.title=event.eventList.length+" "+parallelText,event.tooltip&&(event.tooltip=event.title))}function calculateWidth(event){return event.start.day()===event.end.day()?(event.end.diff(event.start,"days")+1)*(100/7)+"%":Math.ceil(event.end.diff(event.start,"hours")/24)*(100/7)+"%"}function calculateLeft(event){return(event.start.isoWeekday()-1)*(99.9/7)+"%"}var self=this,parallelText=planningConfiguration.parallelText,MAX_PARALLEL=planningConfiguration.MAX_PARALLEL;init(),$scope.$watchCollection(function(){return[self.events,self.week]},init),_.extend(self,{calculateWidth:calculateWidth,calculateLeft:calculateLeft})}function PlanningLineDirective(){return{restrict:"E",replace:!0,templateUrl:"planning/directives/planning-week-line/planning-week-line.html",controller:PlanningLineController,controllerAs:"line",bindToController:{events:"=",week:"=",oneDayEvents:"=",weekEventCallback:"&"},scope:!0}}angular.module("90Tech.planning").directive("zlPlanningWeekLine",PlanningLineDirective),PlanningLineController.$inject=["$scope","PositionService","planningConfiguration","ColorService"]}(window.angular,window.moment,window._),function(angular,moment,_){"use strict";function PlanningController($scope,planningConfiguration){function init(){if(self.zoom=parseInt(self.zoom),self.allowedDays=planningConfiguration.DAYS,(!self.zoom||self.zoom<1)&&(self.zoom=1),self._dayStart=parseTime(self.dayStart?self.dayStart:0),self._dayEnd=parseTime(self.dayEnd?self.dayEnd:24),self.width=self.zoom*(parseInt(self._dayEnd.h)-parseInt(self._dayStart.h)+1)*BASE_SIZE+"px",self.sortedEvents=void 0,"week"===self.mode)self._events=_.flatten(_.map(self.events,split)),self._events=filter(self._events),self.sortedEvents=_.groupBy(self._events,function(e){return e.start.dayOfYear()}),addMissingDays(self.sortedEvents);else if("day"===self.mode||"week-advanced"===self.mode)self._events=_.flatten(_.map(self.events,split)),self._events=filter(self._events),self.sortedEvents=_.groupBy(self._events,function(e){return e[self.dayField]}),"week-advanced"===self.mode&&(self.sortedEvents=_.mapValues(self.sortedEvents,function(eventsByTechnician){return _.groupBy(eventsByTechnician,function(e){return e.start.weekday()})})),addMissingEntities(self.sortedEvents);else if("month"===self.mode){var firstDay=moment(self.position).date(1).hours(0).minutes(0).seconds(0);self.month=moment(self.position).date(1).hours(0).minutes(0).seconds(0).format("MMMM"),self.decallage=firstDay.isoWeekday()-1,self.decallage<0&&(self.decallage=0),self.oneDayEvents=_(self.events).filter(function(event){return event.start.dayOfYear()===event.end.dayOfYear()&&event.start.month()===moment(self.position).month()}).groupBy(function(event){return Math.floor((event.start.date()+self.decallage)/7.01)}).value(),self.multipleDaysEvents=_(self.events).filter(function(event){return event.start.dayOfYear()!==event.end.dayOfYear()}).map(splitByWeeks).flatten().groupBy(function(event){return Math.floor((event.start.date()+self.decallage)/7.01)}).value();for(var i=0;5>i;i++)void 0===self.multipleDaysEvents[i]&&(self.multipleDaysEvents[i]=[]);if(self.days=[],firstDay.isoWeekday()-1>0)for(i=0;i<firstDay.isoWeekday()-1;i++)self.days.unshift({});_.times(firstDay.daysInMonth(),function(n){var day=moment(firstDay).add(n,"days");self.days.push({date:day,events:[]})});for(var displayedDaysCount=self.days.length>35?42:35;self.days.length<displayedDaysCount;)self.days.push({})}}function split(event){event=angular.copy(event);var start=moment(event.start).hour(self._dayStart.h).minute(self._dayStart.m).second(0),stop=moment(event.end).hour(self._dayEnd.h).minute(self._dayEnd.m).second(59);if(event.start.dayOfYear()===event.end.dayOfYear()){if(event.start.isBefore(start)){if(event.end.isBefore(start))return[];event.start=start}if(event.end.isAfter(stop)){if(event.start.isAfter(stop))return[];event.end=stop}return[event]}var first_event=angular.copy(event);first_event.end=moment(event.start).hour(self._dayEnd.h).minute(self._dayEnd.m).second(59),event.start.isBefore(start)&&(first_event.start=start);var startNextDay=moment(event.start).add(1,"day").hour(self._dayStart.h).minute(self._dayStart.m),endThisDay=moment(event.start).hour(self._dayEnd.h).minute(self._dayEnd.m);if(event.end.isBefore(startNextDay))return first_event.start.isAfter(endThisDay)?[]:[first_event];first_event.continuedAfter=!0;var second_event=angular.copy(event);return second_event.start=moment(event.start).add(1,"day").hour(self._dayStart.h).minute(self._dayStart.m),second_event.continuedBefore=!0,event.start.isAfter(endThisDay)?split(second_event):[first_event].concat(split(second_event))}function splitByWeeks(event){if(event.start.isAfter(event.end)){var st=event.start;event.start=event.end,event.end=st}if(event.start.month()<self.position.month()){if(event.end.month()<self.position.month())return[];event.start=moment(self.position).startOf("month")}if(event.end.month()>self.position.month()){if(event.start.month()>self.position.month())return[];event.end=moment(self.position).endOf("month")}if(event.start.isoWeek()===event.end.isoWeek())return[event];var firstEvent=angular.copy(event),secondEvent=angular.copy(event);return firstEvent.continuedAfter=!0,secondEvent.continuedBefore=!0,firstEvent.end=moment(firstEvent.start).endOf("week"),secondEvent.start.add(1,"week").startOf("week"),[firstEvent].concat(splitByWeeks(secondEvent))}function filter(events){return _.filter(events,function(e){var start,stop;return"week"===self.mode||"week-advanced"===self.mode?(start=moment(self.position).weekday(0).hour(self._dayStart.h).minute(self._dayStart.m).second(0),stop=moment(self.position).weekday(6).hour(self._dayEnd.h).minute(self._dayEnd.m).second(59)):"day"===self.mode?(start=moment(self.position).hour(self._dayStart.h).minute(self._dayStart.m).second(0),stop=moment(self.position).hour(self._dayEnd.h).minute(self._dayEnd.m).second(59)):"month"===self.mode&&(start=moment(self.position).date(1).hour(self._dayStart.h).minute(self._dayStart.m).second(0),stop=moment(self.position).weekday(moment(self.position).daysInMonth()).hour(self._dayEnd.h).minute(self._dayEnd.m).second(59)),e.start.isBetween(start,stop)||e.end.isBetween(start,stop)})}function addMissingDays(sortedEvents){sortedEvents=sortedEvents||{};var startingDay=moment(self.position).weekday(0).dayOfYear();_.times(7,function(i){startingDay>=358&&sortedEvents[i]&&(sortedEvents[startingDay+5+i]=sortedEvents[i],delete sortedEvents[i]),sortedEvents[startingDay+i]||(sortedEvents[startingDay+i]=[])})}function addMissingEntities(sortedEvents){sortedEvents=sortedEvents||{},_.each(self.entities,function(e){sortedEvents[e]||(sortedEvents[e]=[])})}function parseTime(h){return h>=24?{h:23,m:59}:{h:h,m:0}}function keys(sortedEvents){return"week"===self.mode?Object.keys(sortedEvents):"day"===self.mode||"week-advanced"===self.mode?Object.keys(sortedEvents).sort():void 0}function getEvents(key){return self.sortedEvents[key]}function isToday(n){return self.position.week()===moment().week()&&n===moment().dayOfYear()}function isInDayRange(){return moment().hour()>parseInt(self._dayStart.h)&&moment().hour()<parseInt(self._dayEnd.h)}function currentTimeToPixels(){var totalMinutes=60*(moment().hour()-parseInt(self._dayStart?self._dayStart.h:0))+moment().minutes();return Math.floor(self.zoom*(BASE_SIZE*totalMinutes)/60)}function isCurrent(){return self.position.isSame(moment(),self.mode)}function clickCallbackWrapper(opts){var mom,entity;"week"===self.mode?mom=moment(self.position).hour(opts.h).minute(opts.m).second(0).dayOfYear(opts.d):"day"===self.mode?mom=moment(self.position).hour(opts.h).minute(opts.m):"week-advanced"===self.mode&&(mom=moment(self.position).hour(opts.h).minute(opts.m).second(0).day(opts.d)),("day"===self.mode||"week-advanced"===self.mode)&&(entity=opts.entity),self.clickCallback({$moment:mom,$entity:entity})}function clickWeekEvent(day,$event){day.date&&self.clickCallback({$moment:day.date})}function dropEvent(config){var mom=config.moment;mom||("week"===self.mode?mom=moment(self.position).hour(config.h).minute(config.m).second(0).dayOfYear(config.d):"week-advanced"===self.mode?mom=moment(self.position).hour(config.h).minute(config.m).second(0).weekday(config.d):"day"===self.mode&&(mom=moment(self.position).hour(config.h).minute(config.m)));var entity="week-advanced"===self.mode||"day"===self.mode?config.entity:void 0;self.dropCallback({$moment:mom,$data:config.$data,$event:config.$event,$entity:entity})}var BASE_SIZE=planningConfiguration.BASE_SIZE,self=this;init(),$scope.$watchCollection(function(){return[self.events,self.entities,self.position,self.mode,self.dayStart,self.dayEnd,self.zoom]},init),_.extend(self,{isToday:isToday,currentTimeToPixels:currentTimeToPixels,isCurrent:isCurrent,clickCallbackWrapper:clickCallbackWrapper,isInDayRange:isInDayRange,keys:keys,getEvents:getEvents,clickWeekEvent:clickWeekEvent,dropEvent:dropEvent})}function PlanningDirective(){return{restrict:"E",templateUrl:"planning/directives/planning/planning.html",controller:PlanningController,controllerAs:"planning",bindToController:{zoom:"=",events:"=",entities:"=",position:"=",mode:"=",dayStart:"=",dayEnd:"=",dayField:"=",eventCallback:"&",dayCallback:"&",clickCallback:"&",weekEventCallback:"&",dropCallback:"&"},scope:{}}}angular.module("90Tech.planning").directive("zlPlanning",PlanningDirective),PlanningController.$inject=["$scope","planningConfiguration"]}(window.angular,window.moment,window._),function(angular){"use strict";angular.module("90Tech.planning").filter("day",[function(){return function(day){return void 0===day||null===day||isNaN(day)||parseInt(day)>6?"":["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"][day]}}])}(window.angular),function(angular){"use strict";angular.module("90Tech.planning").filter("format",function(){return function(time,format){return time.format(format)}}).filter("capitalize",function(){return function(str){return str?str.charAt(0).toUpperCase()+str.slice(1):""}})}(window.angular),function(angular){"use strict";function RangeFilter(){var operation=function(input,total){total=parseInt(total);for(var i=0;total>i;i++)input.push(i);return input};return operation}angular.module("90Tech.planning").filter("range",RangeFilter)}(window.angular),function(angular){"use strict";angular.module("90Tech.planning").filter("strPlanning",["planningConfiguration",function(planningConfiguration){return function(val){return planningConfiguration.strings[val]}}])}(window.angular),function(angular,_,moment){"use strict";function ColorService(){function getLuminance(c){c=c||"#ffffff";var r,g,b,rgbRegex=/rgb\((\d{1,3}),(\d{1,3}),(\d{1,3})\)/;if(rgbRegex.test(c)){var exec=rgbRegex.exec(c);r=parseInt(exec[1]),g=parseInt(exec[2]),b=parseInt(exec[3])}else{var color=c.substring(1),rgb=parseInt(color,16);r=rgb>>16&255,g=rgb>>8&255,b=rgb>>0&255}var luma=.2126*r+.7152*g+.0722*b;return luma}var self=this;_.extend(self,{getLuminance:getLuminance})}angular.module("90Tech.planning").service("ColorService",ColorService),ColorService.$inject=[]}(window.angular,window._,window.moment),function(angular){"use strict";angular.module("90Tech.planning").provider("planningConfiguration",function(){var self=this;self.BASE_SIZE=10,self.MAX_PARALLEL=3,self.strings={nothing_to_show:"Rien Ã  afficher"},self.DAYS=[0,1,2,3,4,5,6],self.parallelText="parallel items",this.setParallelText=function(text){self.parallelText=""+text},this.setBaseSize=function(size){self.BASE_SIZE=size},this.setMaxParallel=function(number){self.MAX_PARALLEL=number},this.setString=function(key,value){self.strings[key]=value},this.setDays=function(value){self.DAYS=value},this.$get=[function(){return{strings:self.strings,BASE_SIZE:self.BASE_SIZE,MAX_PARALLEL:self.MAX_PARALLEL,parallelText:self.parallelText,DAYS:self.DAYS}}]})}(window.angular),function(angular,_,moment){"use strict";function PositionService(){function overlap(lines,event,maxParallelEvents,toRemove,doublecheck){for(var range=event.pre>0?moment.range(moment(event.start).subtract(event.pre,"minutes"),moment(event.end)):event.range,i=0;i<lines.length;i++){if(event.depth>maxParallelEvents){var overlap=!1;if(_.each(lines[maxParallelEvents],function(elt){var eltRange=elt.pre>0?moment.range(moment(elt.start).subtract(elt.pre,"minutes"),moment(elt.end)):elt.range;overlap=range.overlaps(eltRange),!overlap&&doublecheck&&(overlap=event.start.day()===elt.start.day()||event.start.day()===elt.end.day()||event.end.day()===elt.start.day()||event.end.day()===elt.end.day()),overlap&&(elt.start=moment.min(event.start,elt.start),elt.end=moment.max(event.end,elt.end),elt.range=moment.range(elt.start,elt.end),elt.line=maxParallelEvents,elt.eventList.push(event),elt.technician!==event.technician&&(elt.technician="",event.technician=""))}),overlap){toRemove.push(event);break}if(event.depth=maxParallelEvents,event.line=maxParallelEvents,!event.eventList){var eventClone=_.cloneDeep(event);event.eventList=[eventClone]}lines[maxParallelEvents].push(event);break}if(!lines[i].length){lines[i].push(event),event.line=i;break}if(!_.filter(lines[i],function(elt){var eltRange=elt.pre>0?moment.range(moment(elt.start).subtract(elt.pre,"minutes"),moment(elt.end)):elt.range;return overlap=range.overlaps(eltRange),!overlap&&doublecheck&&(overlap=event.start.day()===elt.start.day()||event.start.day()===elt.end.day()||event.end.day()===elt.start.day()||event.end.day()===elt.end.day()),overlap?(elt.depth+=1,!0):void 0}).length){lines[i].push(event),event.line=i;break}event.depth+=1,lines[i+1]||(lines[i+1]=[])}}var self=this;_.extend(self,{overlap:overlap})}angular.module("90Tech.planning").service("PositionService",PositionService),PositionService.$inject=[]}(window.angular,window._,window.moment),angular.module("90Tech.planning").run(["$templateCache",function($templateCache){"use strict";$templateCache.put("planning/directives/planning-day-block/planning-day.html",'<div class="day-block" ng-class="{\'empty-day\': dayCtrl.isDefined }" ng-click="planning.dayCallback({$day:dayCtrl.day.date})">\n    <div style="position:absolute;left:5px;top:5px;" ng-if="dayCtrl.day.date.day() === 1">{{dayCtrl.day.date.week()}}</div>\n    <div class="day-number">{{ dayCtrl.day.date.date() }}</div>\n    <div class="events-container">\n\n        <div ng-style="{\'background-color\': event.color}" class="month-event"\n             ng-repeat="event in dayCtrl.day.events |limitTo:5">{{event.title}}\n        </div>\n    </div>\n\n</div>'),$templateCache.put("planning/directives/planning-left-column/planning-left-column.html",'<div class="left-column" ng-switch="planningLeftColumn.mode">\n    <div class="planning-head"></div>\n    <div class="left-body">\n    <div class="planning-2pc"></div>\n        <div class="days-body" ng-switch-when="week">\n            <div class="dayName row8 b-b animate"\n                 ng-repeat="day in planningLeftColumn.days"\n                    ng-class="{today: planning.isToday(day.dayOfYear())}"\n                    ng-click="planning.dayCallback({$day:day})">\n                <h4>\n                    {{day | format:\'dddd\' | capitalize}}<br>\n                    <small>{{day | format:\'ll\'}}</small>\n                </h4>\n            </div>\n        </div>\n        <div class="days-body" ng-switch-when="day">\n            <div class="dayName row8 b-b animate"\n                 ng-repeat="col in planningLeftColumn.column">\n                <h4>\n                    {{col}}\n                </h4>\n            </div>\n        </div>\n    </div>\n    <div style="height:10px"><!-- compensate for scrollbar --></div>\n</div>'),
$templateCache.put("planning/directives/planning-line/planning-line.html",'<div\n        zl-planning-drag-drop\n        zl-drop="line.dropEvent($data, $event)">\n    <div class="b-b b-r all-day day-hour"\n         ng-style="{width: line.calcWidth(line.zoom)}"\n         ng-repeat="n in [] | range:line.range"\n         ng-dblclick="line.clickEvent(n, $event)"\n         hour="{{n}}">\n        <span class="half-hour"></span>\n\n    </div>\n</div>\n\n<div ng-repeat="event in line._events"\n     zl-planning-drag-drop\n     ng-click="planning.eventCallback({\'event\':event})"\n     zl-drag="event"\n     ng-style="{\n        height: event.style.height,\n        top: event.style.top,\n        width: event.pre > 0 ? line.preEvent[event.id].style.totalWidth : event.style.width,\n        left: event.pre > 0 ? line.preEvent[event.id].style.left : event.style.left\n    }" style="position: absolute;"\n>\n    <div ng-if="event.pre > 0" ng-style="{width: line.preEvent[event.id].percentage, \'background\': line.preEvent[event.id].style[\'background\']}"\n         style="display: inline-block; position: relative; height: 100%; text-align: center; color: white; border: 1px lightgrey solid; border-right: none;"\n         class="pre-event"\n         tooltip-append-to-body="true"\n         uib-tooltip="{{line.preEvent[event.id].tooltip}}">\n        <div class="title-container">\n            <span>\n            <i style="height: 100%; font-size: 1.2em;" class="mdi mdi-car"></i>\n            </span>\n        </div>\n\n    </div>\n    <div class="event" style="display: inline-block; position: relative; height: 100%;"\n         tooltip-append-to-body="true"\n         uib-tooltip="{{event.tooltip}}"\n         ng-style="{\n         width: event.percentage,\n         background: event.style[\'background-color\'],\n         color: event.style.color,\n         \'border-left\': event.pre > 0 ? \'none\': \'\'\n         }">\n        <div class="event-line-container" style="">\n            <div class="event-line" ng-style="{\'background-color\': event.color}" ng-if="!event.continuedBefore"></div>\n        </div>\n\n        <div class="title-container"><span>{{event.title}}</span></div>\n    </div>\n</div>\n\n\n<!--<div class="event"-->\n<!--zl-planning-drag-drop-->\n<!--zl-drag="event"-->\n<!--ng-repeat="event in line._events"-->\n<!--ng-style="event.style"-->\n<!--ng-class="{\'continued-before\': event.continuedBefore, \'continued-after\': event.continuedAfter}"-->\n<!--ng-click="planning.eventCallback({\'event\':event})"-->\n<!--tooltip-append-to-body="true"-->\n<!--uib-tooltip="{{event.tooltip}}">-->\n<!--&lt;!&ndash;<span class="calendar-urgency bg-pink"></span>&ndash;&gt;-->\n\n<!--<div class="event-line-container" style="">-->\n<!--<div class="event-line" ng-style="{\'background-color\': event.color}" ng-if="!event.continuedBefore"></div>-->\n<!--</div>-->\n\n<!--<div class="title-container"><span>{{event.title}}</span></div>-->\n<!--</div>-->\n\n'),$templateCache.put("planning/directives/planning-top-row/planning-top-row.html",'<div class="planning-top-row">\n    <div ng-repeat="hour in planningTopRow.hours" class="day-hour"\n         ng-style="{width: planningTopRow.calcWidth(planningTopRow.zoom), margin: planningTopRow.calcMargin(planningTopRow.zoom, $index)}">\n        <h4>{{hour |Â format:\'HH:mm\'}}</h4>\n    </div>\n</div>\n\n'),$templateCache.put("planning/directives/planning-vertical-line/planning-vertical-line.html",'<div\n        zl-planning-drag-drop\n        zl-drop="line.dropEvent($data, $event)">\n    <div class="b-b b-r all-day"\n         ng-style="{height: line.calcWidth(line.zoom)}"\n         ng-repeat="n in [] | range:line.range"\n         ng-dblclick="line.clickEvent(n, $event)"\n         hour="{{n}}">\n        <span class="hour-text">{{n+1}}</span>\n    </div>\n</div>\n\n<div ng-repeat="event in line._events"\n     zl-planning-drag-drop\n     ng-click="planning.eventCallback({\'event\':event})"\n     zl-drag="event"\n     ng-style="{\n        width: event.style.height,\n        right: event.style.top,\n        height: event.pre > 0 ? line.preEvent[event.id].style.totalWidth : event.style.width,\n        top: event.pre > 0 ? line.preEvent[event.id].style.left : event.style.left\n    }" style="position: absolute;"\n>\n     <div ng-if="event.pre > 0" ng-style="{height: line.preEvent[event.id].percentage, \'background\': line.preEvent[event.id].style[\'background\']}"\n             style="display: inline-block; position: relative; width: 100%; text-align: center; color: white; border: 1px lightgrey solid; border-right: none;"\n             class="pre-event"\n             tooltip-append-to-body="true"\n             uib-tooltip="{{line.preEvent[event.id].tooltip}}">\n            <div class="title-container">\n                <span>\n                <i style="width: 100%; font-size: 1.2em;" class="mdi mdi-car"></i>\n                </span>\n            </div>\n\n        </div>\n\n    <div class="event" style="display: inline-block; position: relative; width: 100%;"\n         tooltip-append-to-body="true"\n         uib-tooltip="{{event.tooltip}}"\n         ng-style="{\n             height: event.percentage,\n             background: event.style[\'background-color\'],\n             color: event.style.color,\n             \'border-left\': event.pre > 0 ? \'none\': \'\'\n             }">\n        <div class="event-line-container" style="">\n            <div class="event-line" ng-style="{\'background-color\': event.color}" ng-if="!event.continuedBefore"></div>\n        </div>\n\n        <div class="title-container"><span>{{event.title}}</span></div>\n    </div>\n</div>\n\n\n<!--<div class="event"-->\n<!--zl-planning-drag-drop-->\n<!--zl-drag="event"-->\n<!--ng-repeat="event in line._events"-->\n<!--ng-style="event.style"-->\n<!--ng-class="{\'continued-before\': event.continuedBefore, \'continued-after\': event.continuedAfter}"-->\n<!--ng-click="planning.eventCallback({\'event\':event})"-->\n<!--tooltip-append-to-body="true"-->\n<!--uib-tooltip="{{event.tooltip}}">-->\n<!--&lt;!&ndash;<span class="calendar-urgency bg-pink"></span>&ndash;&gt;-->\n\n<!--<div class="event-line-container" style="">-->\n<!--<div class="event-line" ng-style="{\'background-color\': event.color}" ng-if="!event.continuedBefore"></div>-->\n<!--</div>-->\n\n<!--<div class="title-container"><span>{{event.title}}</span></div>-->\n<!--</div>-->\n\n'),$templateCache.put("planning/directives/planning-week-line/planning-week-line.html",'<div class="week-line" ng-class="\'week-\' + line.week " style="padding-top:20px;" >\n    <div class="single-day-events" style="height:40%; position:relative;">\n        <div\n                zl-planning-drag-drop\n                zl-drag="ev"\n                ng-repeat="ev in line.oneDayEvents"\n                ng-style="{\'top\': ev.style.top, \'height\': ev.style.height, \'background-color\': ev.style[\'background-color\'], \'color\' : ev.style.color, \'width\': ev.style.width, \'left\': ev.style.left}"\n                style="position:absolute;border: 1px solid black;pointer-events: auto; overflow: hidden;"\n                ng-click="planning.weekEventCallback({event: ev})"\n                tooltip-append-to-body="true"\n                uib-tooltip="{{ev.tooltip}}"\n                class="single-day-event">\n            <div class="event-line-container">\n                <div class="event-line" ng-style="{\'background-color\': ev.color}" ng-if="!ev.continuedBefore"></div>\n            </div>\n            <div class="single-day-event-title">\n                <span>{{ev.title}}</span>\n            </div>\n        </div>\n    </div>\n    <div class="multiple-days-events" style="height:40%; position: relative;">\n        <div class="multiple-day-event" ng-repeat="event in line.displayedEvents"\n             style="position: absolute; border: 1px solid black;pointer-events: auto; overflow: hidden;"\n             zl-planning-drag-drop\n             zl-drag="event"\n             ng-click="planning.weekEventCallback({event: event})"\n             tooltip-append-to-body="true"\n             uib-tooltip="{{event.tooltip}}"\n'+"             ng-style=\"{'top': event.style.top, 'height': event.style.height, 'background-color': event.style['background-color'], 'color' : event.style.color, 'width': event.style.width, 'left': event.style.left}\">\n            <div class=\"event-line-container\">\n                <div class=\"event-line\" ng-style=\"{'background-color': event.color}\"\n                     ng-if=\"!event.continuedBefore\"></div>\n            </div>\n            <div class=\"multiple-day-event-title\">\n                <span>{{event.title}}</span>\n            </div>\n        </div>\n    </div>\n</div>\n"),$templateCache.put("planning/directives/planning/planning.html",'<div ng-if="planning.mode ===\'day\' || planning.mode === \'week\'" style="height: 100%;">\n    <zl-planning-left-column mode="planning.mode" position="planning.position" day-field="planning.dayField"\n                             events="planning.sortedEvents"></zl-planning-left-column>\n    <div class="" style="height:100%">\n        <div zl-horizontal-scroll scroll-left="planning.currentTimeToPixels()" style="height:100%">\n            <div ng-style="{width: planning.width}" class="planning-body">\n                <zl-planning-top-row mode="planning.mode" zoom="planning.zoom" position="planning.position"\n                                     day-start="planning._dayStart" day-end="planning._dayEnd"></zl-planning-top-row>\n                <div class="hour-cursor" ng-style="{left: planning.currentTimeToPixels()+\'px\'}"\n                     ng-if="planning.isCurrent() && planning.isInDayRange()">\n                    <div class="hour-caret"></div>\n                </div>\n                <div class="planning-2pc"></div>\n                <zl-planning-line\n                        zoom="planning.zoom"\n                        day-start="planning._dayStart" day-end="planning._dayEnd"\n                        ng-repeat="i in planning.keys(planning.sortedEvents)" class="day b-b"\n                        ng-class="{today: planning.isToday(i)}" events="planning.getEvents(i)"\n                        drop-callback="planning.dropEvent({h: $hour, m: $minutes, d: i, entity: i, $data: $data, $event: $event})"\n                        click-callback="planning.clickCallbackWrapper({h: $hour, m: $minutes, d: i, entity: i})"></zl-planning-line>\n                <!-- TODO fix dopEvent and clickCallbackWrapper it can contain day of year as well as entity -->\n            </div>\n        </div>\n    </div>\n</div>\n\n<div ng-if="planning.mode ===\'week-advanced\'" class="advanced-week">\n    <div class="days-list">\n        <div class="day-advanced">&nbsp;</div>\n        <div class="day-advanced" ng-repeat="day in planning.allowedDays">\n            <span class="day-text"\n            >{{day | day}}</span></div>\n    </div>\n\n    <div class="advanced-week-container"\n         ng-repeat="name in planning.keys(planning.sortedEvents)">\n        <div class="left-column-advanced">\n            <span style="margin:auto">{{name}}</span>\n        </div>\n        <div ng-repeat="day in planning.allowedDays"\n             class="day-advanced">\n            <zl-planning-vertical-line\n                    zoom="planning.zoom"\n                    drop-callback="planning.dropEvent({h: $hour, m: $minutes, d:day, entity: name, $data: $data, $event: $event})"\n                    day-start="planning._dayStart" day-end="planning._dayEnd"\n                    events=" planning.getEvents(name)[day]"\n                    click-callback="planning.clickCallbackWrapper({h: $hour, m: $minutes, d: day, entity: name})">\n            </zl-planning-vertical-line>\n        </div>\n    </div>\n\n\n</div>\n\n\n<div ng-if="planning.mode === \'month\'" style="height: 100%; z-index: 1000;">\n    <div class="month-header">\n        <span class="month-text">{{planning.month | capitalize}}</span>\n    </div>\n    <div class="day-header">\n        <div class="day" ng-repeat="day in []|range:7"><span class="day-text">{{day | day}}</span></div>\n    </div>\n    <div class="month-container">\n        <zl-planning-day ng-repeat="day in planning.days" day="day" events="planning._events"\n                         drop-callback="planning.dropEvent({$data: $data, $event: $event, moment: day.date})"\n                         ng-dblclick="planning.clickWeekEvent(day, $event)"></zl-planning-day>\n        <zl-planning-week-line ng-repeat="(week, events) in planning.multipleDaysEvents" events="events" week="week"\n                               one-day-events="planning.oneDayEvents[week]"\n                               style="height: 20%; pointer-events: none"></zl-planning-week-line>\n    </div>\n</div>\n')}]);
//# sourceMappingURL=planning.sourcemap