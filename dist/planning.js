"use strict";!function(e){e.module("90Tech.planning",["pikaday","zlContextMenu"])}(window.angular),function(e){e.module("90Tech.planning").filter("day",[function(){return function(e){return void 0===e||null===e||isNaN(e)||parseInt(e)>6?"":["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"][e]}}])}(window.angular),function(e){e.module("90Tech.planning").filter("format",function(){return function(e,n){return e.format(n)}}).filter("capitalize",function(){return function(e){return e?e.charAt(0).toUpperCase()+e.slice(1):""}})}(window.angular),function(e){function n(){var e=function(e,n){n=parseInt(n);for(var t=0;t<n;t++)e.push(t);return e};return e}e.module("90Tech.planning").filter("range",n)}(window.angular),function(e){e.module("90Tech.planning").filter("strPlanning",["planningConfiguration",function(e){return function(n){return e.strings[n]}}])}(window.angular),function(e,n,t){function a(){function a(n,a){if(!Array.isArray(a))throw new Error("Invalid interval");var o=n.filter(function(e){return t.range(e.start,e.end).overlaps(t.range(a[0],a[1]))}).map(function(n){return n.style={},t(n.start).isSame(t(e.copy(a[0])))&&(n.style.top="0px",n.start=a[0]),t(n.start).isBefore(t(e.copy(a[0])))&&(n.start=a[0],n.style.top="0px"),t(n.end).isAfter(t(e.copy(a[1])))&&(n.end=a[1]),n});return i(o)}function i(a){for(var i=!0;i;){var o=a;i=!1;var r=o.map(function(e,n){return e.index=n,Object.assign({},e,{index:n})});if(!n.any(r,function(e){return n.any(r,function(n){return e.index!==n.index&&overlaps(e,n)})}))return o;var s=o.reduce(function(n,a,i,o){var r=o[i+1];return r&&a?(overlaps({start:t(e.copy(a.start)).toDate(),end:t(e.copy(a.end)).toDate()},{start:t(e.copy(r.start)).toDate(),end:t(e.copy(r.end)).toDate()})&&n.push({start:t.min(t(e.copy(a.start)),t(e.copy(r.start))),end:t.max(t(e.copy(a.end)),t(e.copy(r.end)))}),n):n},[]);a=s,i=!0,r=s=void 0}}var o=this;n.extend(o,{parseAbsences:a})}e.module("90Tech.planning").service("AbsenceService",a)}(window.angular,window._,window.moment),function(e,n,t){function a(){function e(e){e=e||"#ffffff";var n,t,a,i=/rgb\((\d{1,3}),(\d{1,3}),(\d{1,3})\)/;if(i.test(e)){var o=i.exec(e);n=parseInt(o[1]),t=parseInt(o[2]),a=parseInt(o[3])}else{var r=e.substring(1),s=parseInt(r,16);n=s>>16&255,t=s>>8&255,a=s>>0&255}var l=.2126*n+.7152*t+.0722*a;return l}var t=this;n.extend(t,{getLuminance:e})}e.module("90Tech.planning").service("ColorService",a),a.$inject=[]}(window.angular,window._,window.moment),function(e){e.module("90Tech.planning").provider("planningConfiguration",function(){var e=this;e.BASE_SIZE=10,e.MAX_PARALLEL=3,e.strings={nothing_to_show:"Rien à afficher"},e.DAYS=[0,1,2,3,4,5,6],e.parallelText="parallel items",this.setParallelText=function(n){e.parallelText=""+n},this.setBaseSize=function(n){e.BASE_SIZE=n},this.setMaxParallel=function(n){e.MAX_PARALLEL=n},this.setString=function(n,t){e.strings[n]=t},this.setDays=function(n){e.DAYS=n},this.$get=[function(){return{strings:e.strings,BASE_SIZE:e.BASE_SIZE,MAX_PARALLEL:e.MAX_PARALLEL,parallelText:e.parallelText,DAYS:e.DAYS,absentTechnicianCallback:function(e){e()},isFerieCallback:function(e){e()},warningCallback:function(e){e()}}}]})}(window.angular),function(e,n,t){function a(e){function a(e,a){function o(a){return n.map(a,function(n){var a=e.start.isAfter(n.start)?e.start:n.start,i=e.end.isBefore(n.end)?e.end:n.end,o=t.range(a,i),r=o.diff("milliseconds"),s=r/p*100,l=c.clone();if(l.subtract(o),!l.length)return{range:o,endPercentage:100,startPercentage:0};var d=(l[0].diff("milliseconds")||p)/p*100;return{range:o,endPercentage:s+d,startPercentage:d}})}var r=e.style["background-color"],s=i(r),l=e.start,d=e.end,c=t.range(l,d),p=c.diff("milliseconds"),u=o(e.pauses),y=n.reduce(u,function(e,n){return e+", "+r+" "+n.startPercentage+"%, "+s+" "+n.startPercentage+"%, "+s+" "+n.endPercentage+"%, "+r+" "+n.endPercentage+"%"},"linear-gradient("+a+", "+r);return y+=", "+r+" 100%)"}function i(e){if(0===e.indexOf("#")&&(e=e.slice(1)),3===e.length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]),6!==e.length)throw new Error("Invalid HEX color.");var n=(255-parseInt(e.slice(0,2),16)).toString(16),t=(255-parseInt(e.slice(2,4),16)).toString(16),a=(255-parseInt(e.slice(4,6),16)).toString(16);return"#"+o(n)+o(t)+o(a)}function o(e,n){n=n||2;var t=new Array(n).join("0");return(t+e).slice(-n)}var r=this;n.extend(r,{generateGradient:a})}e.module("90Tech.planning").service("PauseService",a),a.$inject=["ColorService"]}(window.angular,window._,window.moment),function(e,n,t){function a(){function e(e,a,i,o,r){for(var s=a.pre>0?t.range(t(a.start).subtract(a.pre,"minutes"),t(a.end)):a.range,l=0;l<e.length;l++){if(a.depth>i){var d=!1;if(n.each(e[i],function(e){var n=e.pre>0?t.range(t(e.start).subtract(e.pre,"minutes"),t(e.end)):e.range;d=s.overlaps(n),!d&&r&&(d=a.start.day()===e.start.day()||a.start.day()===e.end.day()||a.end.day()===e.start.day()||a.end.day()===e.end.day()),d&&(e.start=t.min(a.start,e.start),e.end=t.max(a.end,e.end),e.range=t.range(e.start,e.end),e.line=i,e.eventList.push(a),e.technician!==a.technician&&(e.technician="",a.technician=""))}),d){o.push(a);break}if(a.depth=i,a.line=i,!a.eventList){var c=n.cloneDeep(a);a.eventList=[c]}e[i].push(a);break}if(!e[l].length){e[l].push(a),a.line=l;break}if(!n.filter(e[l],function(e){var n=e.pre>0?t.range(t(e.start).subtract(e.pre,"minutes"),t(e.end)):e.range;if(d=s.overlaps(n),!d&&r&&(d=a.start.day()===e.start.day()||a.start.day()===e.end.day()||a.end.day()===e.start.day()||a.end.day()===e.end.day()),d)return e.depth+=1,!0}).length){e[l].push(a),a.line=l;break}a.depth+=1,e[l+1]||(e[l+1]=[])}}var a=this;n.extend(a,{overlap:e})}e.module("90Tech.planning").service("PositionService",a),a.$inject=[]}(window.angular,window._,window.moment),function(e,n){e.module("90Tech.planning").directive("zlPlanningDragDrop",function(){return{controller:function(){},scope:{},controllerAs:"dragDropCtrl",bindToController:{zlDrag:"=",zlDrop:"&"},link:function(e,t){var a=document.createElement("div"),i=t[0];window.addEventListener("dragover",function(e){e.target.classList.contains(e.target.id)&&e.target.classList.add("absence-hover"),e.preventDefault()},!1),window.addEventListener("drop",function(e){e.preventDefault()},!1),i.attributes["zl-drag"]&&(i.draggable=!0,i.addEventListener("dragstart",function(t){return a.style.height=i.clientHeight+"px",a.style.zIndex="1000",a.style.position="relative",a.style.left="-10000px",a.style.bottom="-10000px;",a.innerHTML=i.innerHTML,i.children.length>1?(a.children[0].style.float="left",a.style.backgroundColor=i.children[1].style.backgroundColor,a.style.width=i.clientWidth+"px"):(a.style.width=Math.min(i.clientWidth,200)+"px",a.style.backgroundColor=i.children[0].style.backgroundColor),t.dataTransfer.effectAllowed="move",document.body.appendChild(a),t.dataTransfer.setDragImage&&t.dataTransfer.setDragImage(a,0,0),n.each(document.querySelectorAll(".planning-event-tooltip"),function(e){e.remove()}),t.dataTransfer.setData("Text",JSON.stringify(e.dragDropCtrl.zlDrag)),this.classList.add("drag"),!1},!1),i.addEventListener("dragend",function(e){return a.remove(),this.classList.remove("drag"),!1},!1)),i.attributes["zl-drop"]&&(i.addEventListener("drop",function(n){n.preventDefault(),n.stopPropagation(),n.stopPropagation&&n.stopPropagation(),n.target.classList.remove("over"),this.classList.remove("over");var t=!0,a=!1,i=void 0;try{for(var o,r=document.getElementsByClassName("absence")[Symbol.iterator]();!(t=(o=r.next()).done);t=!0){var s=o.value;s.classList.remove("absence-hover")}}catch(e){a=!0,i=e}finally{try{!t&&r.return&&r.return()}finally{if(a)throw i}}return e.$apply(function(){e.dragDropCtrl.zlDrop({$data:JSON.parse(n.dataTransfer.getData("Text")),$event:n})}),!1},!1),i.addEventListener("dragenter",function(e){return e.target.classList.add("over"),!1},!1),i.addEventListener("dragleave",function(e){var n=!0,t=!1,a=void 0;try{for(var i,o=document.getElementsByClassName("absence")[Symbol.iterator]();!(n=(i=o.next()).done);n=!0){var r=i.value;r.classList.remove("absence-hover")}}catch(e){t=!0,a=e}finally{try{!n&&o.return&&o.return()}finally{if(t)throw a}}return e.target.classList.remove("over"),!1},!1))}}})}(window.angular,_),function(e){function n(e){return{restrict:"A",scope:{scrollLeft:"="},link:function(n,t,a){t.bind("mousewheel",function(e){t[0].scrollLeft-=e.wheelDelta/3}),t.addClass("slider"),n.scrollLeft,e(function(){t[0].scrollLeft=n.scrollLeft-t[0].offsetWidth/2},100)}}}e.module("90Tech.planning").directive("zlHorizontalScroll",n),n.$inject=["$timeout"]}(window.angular),function(e,n,t){function a(a,i){function o(){switch(D.zoom=parseInt(D.zoom),D.allowedDays=D.usableDays.sort()||i.DAYS,D.daysList=D.allowedDays.map(function(e){var t=n(D.position);return t.weekday(e),t}),(!D.zoom||D.zoom<1)&&(D.zoom=1),D._dayStart=u(D.dayStart?D.dayStart:0),D._dayEnd=u(D.dayEnd?D.dayEnd:24),D.width=D.zoom*(parseInt(D._dayEnd.h)-parseInt(D._dayStart.h)+1)*$+"px",D.sortedEvents=void 0,D.mode){case"week":D._events=t.flatten(t.map(D.events,s)),D._events=d(D._events),D.sortedEvents=t.groupBy(D._events,function(e){return e.start.format("DD/MM/YYYY")}),c(D.sortedEvents);break;case"day":case"week-advanced":D._events=t.flatten(t.map(D.events,s)),D._events=d(D._events),D.sortedEvents=t.groupBy(D._events,function(e){return e[D.dayField]}),"week-advanced"===D.mode&&(D.sortedEvents=t.mapValues(D.sortedEvents,function(e){return t.groupBy(e,function(e){return e.start.weekday()})})),p(D.sortedEvents);break;case"3day":D._events=t.flatten(t.map(D.events,s)),D._events=d(D._events),D.sortedEvents=t.reduce(D.entities,function(e,n){return e[n]=[],e},{});t.keys(D.sortedEvents);D.groupedEvents=t.map(t.groupBy(D._events,function(e){return n(e.start).startOf("day").unix()}),function(a,i){var o={key:i,date:n.unix(i).startOf("day").toDate(),day:n.unix(i).startOf("day").format("dddd DD MMMM"),value:t.groupBy(a,function(e){return e.technician}),absences:e.copy(D.absences)};return t.each(D.entities,function(e){o.value[e]||(o.value[e]=[])}),o});for(var a=n(D.position).hour(D._dayStart.h).minute(D._dayStart.m).second(0),o=n(D.position).hour(D._dayEnd.h).minute(D._dayEnd.m).second(59),r=[{start:e.copy(a),end:e.copy(o)}],y=0;y<2;){o.add(1,"day");var v=o.day()-1;v<0&&(v=6),(t.isEmpty(D.allowedDays)||t.includes(D.allowedDays,v))&&(r.push({start:e.copy(o).hour(D._dayStart.h).minute(D._dayStart.m).second(0),end:e.copy(o).hour(D._dayEnd.h).minute(D._dayEnd.m).second(59)}),y++)}t.each(r,function(a){var i=""+n(a.start).startOf("day").unix(),o=t.find(D.groupedEvents,function(e){return e.key===i});if(!o){var r={key:i,date:n(e.copy(a.start)).startOf("day").toDate(),day:n(e.copy(a.start)).startOf("day").format("dddd DD MMMM"),value:{},absences:e.copy(D.absences)};t.each(t.keys(D.sortedEvents),function(e){r.value[e]=[]}),D.groupedEvents.push(r)}}),D.groupedEvents=t.sortBy(D.groupedEvents,function(e){return e.key});break;case"month":var g=n(D.position).date(1).hours(0).minutes(0).seconds(0);D.month=n(D.position).date(1).hours(0).minutes(0).seconds(0).format("MMMM"),D.decallage=g.isoWeekday()-1,D.decallage<0&&(D.decallage=0),D.oneDayEvents=t(D.events).filter(function(e){return e.start.dayOfYear()===e.end.dayOfYear()&&e.start.month()===n(D.position).month()}).groupBy(function(e){return Math.floor((e.start.date()+D.decallage)/7.01)}).value(),D.multipleDaysEvents=t(D.events).filter(function(e){return e.start.dayOfYear()!==e.end.dayOfYear()}).map(l).flatten().groupBy(function(e){return Math.floor((e.start.date()+D.decallage)/7.01)}).value();var f=n(D.position).endOf("month").isoWeek(),h=n(D.position).startOf("month").isoWeek();1===f&&(f=n(D.position).isoWeeksInYear()+1),f<h&&(f=h+f);for(var m=f-h+1,b=0;b<m;b++)void 0===D.multipleDaysEvents[b]&&(D.multipleDaysEvents[b]=[]);if(D.days=[],g.isoWeekday()-1>0)for(b=0;b<g.isoWeekday()-1;b++)D.days.unshift({});t.times(g.daysInMonth(),function(e){var t=n(g).add(e,"days");D.days.push({date:t,events:[]})});for(var k=D.days.length>35?42:35;D.days.length<k;)D.days.push({})}}function r(e){return D.entitiesName.find(function(n){return n._id===e}).fullname}function s(t){for(var a=!0;a;){var i=t;a=!1,i=e.copy(i);var o=n(i.start).hour(D._dayStart.h).minute(D._dayStart.m).second(0),r=n(i.end).hour(D._dayEnd.h).minute(D._dayEnd.m).second(59);if(i.start.dayOfYear()===i.end.dayOfYear()){if(i.start.isBefore(o)){if(i.end.isBefore(o))return[];i.start=o}if(i.end.isAfter(r)){if(i.start.isAfter(r))return[];i.end=r}return[i]}var l=e.copy(i);l.end=n(i.start).hour(D._dayEnd.h).minute(D._dayEnd.m).second(59),i.start.isBefore(o)&&(l.start=o);var d=n(i.start).add(1,"day").hour(D._dayStart.h).minute(D._dayStart.m),c=n(i.start).hour(D._dayEnd.h).minute(D._dayEnd.m);if(i.end.isBefore(d))return l.start.isAfter(c)?[]:[l];l.continuedAfter=!0;var p=e.copy(i);if(p.start=n(i.start).add(1,"day").hour(D._dayStart.h).minute(D._dayStart.m),p.continuedBefore=!0,!i.start.isAfter(c))return[l].concat(s(p));t=p,a=!0,o=r=l=d=c=p=void 0}}function l(t){if(t.start.isAfter(t.end)){var a=t.start;t.start=t.end,t.end=a}if(t.start.year()<D.position.year()||t.start.month()<D.position.month()){if(t.end.year()<D.position.year()||t.end.month()<D.position.month())return[];t.start=n(D.position).startOf("month")}if(t.end.month()>D.position.month()||t.end.year()!==D.position.year()){if(t.start.month()>D.position.month())return[];t.end=n(D.position).endOf("month")}if(t.start.isoWeek()===t.end.isoWeek())return[t];var i=e.copy(t),o=e.copy(t);return i.continuedAfter=!0,o.continuedBefore=!0,i.end=n(i.start).endOf("week"),o.start.add(1,"week").startOf("week"),[i].concat(l(o))}function d(a){return t.filter(a,function(a){var i,o;switch(D.mode){case"week":case"week-advanced":i=n(D.position).weekday(0).hour(D._dayStart.h).minute(D._dayStart.m).second(0),o=n(D.position).weekday(6).hour(D._dayEnd.h).minute(D._dayEnd.m).second(59);break;case"day":i=n(D.position).startOf("day").hour(D._dayStart.h).minute(D._dayStart.m),o=n(D.position).endOf("day").hour(D._dayEnd.h).minute(D._dayEnd.m);break;case"3day":i=n(D.position).hour(D._dayStart.h).minute(D._dayStart.m).second(0),o=n(D.position).hour(D._dayEnd.h).minute(D._dayEnd.m).second(59);for(var r=[{start:e.copy(i),end:e.copy(o)}],s=0;s<2;){o.add(1,"day");var l=o.day()-1;l<0&&(l=6),(t.isEmpty(D.allowedDays)||t.includes(D.allowedDays,l))&&(r.push({start:e.copy(o).hour(D._dayStart.h).minute(D._dayStart.m).second(0),end:e.copy(o).hour(D._dayEnd.h).minute(D._dayEnd.m).second(59)}),s++)}return t.some(r,function(e){return a.start.isBetween(e.start,e.end)||a.end.isBetween(e.start,e.end)});case"month":i=n(D.position).date(1).hour(D._dayStart.h).minute(D._dayStart.m).second(0),o=n(D.position).weekday(n(D.position).daysInMonth()).hour(D._dayEnd.h).minute(D._dayEnd.m).second(59)}return a.start.isBetween(i,o)||a.end.isBetween(i,o)})}function c(a){a=a||{};var i=n(D.position).weekday(0);t.times(7,function(t){var o=n(e.copy(i)).add(t,"days").format("DD/MM/YYYY");a[o]||(a[o]=[])})}function p(e){e=e||{},t.each(D.entities,function(n){e[n]||(e[n]=[])})}function u(e){return e>=24?{h:23,m:59}:{h:e,m:0}}function y(e){switch(D.mode){case"week":return Object.keys(e).sort(function(e,n){var t=x(e),a=x(n);return t-a});case"week-advanced":case"day":case"3day":return D.entitiesName?D.entitiesName.map(function(e){return e._id}):[]}}function v(e){return D.sortedEvents[e]}function g(e){return D.position.week()===n().week()&&e===n().dayOfYear()}function f(e){if(D.holidays)return D.holidays.find(function(t){return n(t.date).format("L")===n(e).format("L")})}function h(a){var i=n(e.copy(a));return t.any(D._absences,function(e){return e.range.contains(i)})}function m(){return n().hour()>parseInt(D._dayStart.h)&&n().hour()<parseInt(D._dayEnd.h)}function b(){var e=60*(n().hour()-parseInt(D._dayStart?D._dayStart.h:0))+n().minutes();return Math.floor(D.zoom*($*e)/60)}function k(){return D.position.isSame(n(),D.mode)}function w(e){var t,a;switch(D.mode){case"week":var i=e.d.split("/");t=n(new Date(i[2],i[1]-1,i[0],e.h,e.m));break;case"3day":case"day":t=n(D.position).hour(e.h).minute(e.m),a=e.entity;break;case"week-advanced":a=e.entity,t=n(D.position).hour(e.h).minute(e.m).second(0).weekday(e.d)}D.clickCallback({$moment:t,$entity:a})}function E(e,n){e.date&&D.clickCallback({$moment:e.date})}function S(e,n){D.showAbsencesCallback({$absences:e,$day:n})}function _(e){var a=e.moment;if(!a)switch(D.mode){case"week":var o=n(x(e.d)).dayOfYear();a=n(D.position).hour(e.h).minute(e.m).second(0).dayOfYear(o);break;case"week-advanced":a=n(D.position).hour(e.h).minute(e.m).second(0).weekday(e.d);break;case"day":a=n(D.position).hour(e.h).minute(e.m);break;case"3day":a=n.unix(e.day).hour(e.h).minute(e.m)}var r=t.includes(["week-advanced","day","3day"],D.mode)?e.entity:void 0;"month"===D.mode&&f(a)?i.isFerieCallback(function(){D.dropCallback({$moment:a,$data:e.$data,$event:e.$event,$entity:r})}):D.dropCallback({$moment:a,$data:e.$data,$event:e.$event,$entity:r})}function x(e){var n=e.split("/");return new Date(n[2],n[1]-1,n[0])}var $=i.BASE_SIZE,D=this;D.$onInit=function(){t.extend(D,{isToday:g,currentTimeToPixels:b,isCurrent:k,clickCallbackWrapper:w,showAbsencesCallBackWrapper:S,isInDayRange:m,keys:y,getEvents:v,clickWeekEvent:E,dropEvent:_,isFerie:f,hasAbsence:h,getName:r}),o()},a.$watchCollection(function(){return[D.events,D.entities,D.position,D.mode,D.dayStart,D.dayEnd,D.zoom,D.usableDays]},o)}function i(){return{restrict:"E",templateUrl:"/directives/planning/planning.html",controller:a,controllerAs:"planning",bindToController:{zoom:"=",events:"=",entities:"=",entitiesName:"=",entitiesPauses:"=?",absences:"=?",position:"=",mode:"=",dayStart:"=",dayEnd:"=",dayField:"=",eventCallback:"&",dayCallback:"&",clickCallback:"&",weekEventCallback:"&",dropCallback:"&",usableDays:"=?",action:"&?",duplicateAction:"&?",holidays:"=",showAbsencesCallback:"&"},scope:{}}}e.module("90Tech.planning").directive("zlPlanning",i),a.$inject=["$scope","planningConfiguration"]}(window.angular,window.moment,window._),function(e,n,t){function a(e){function a(){r.holidays&&r.day.date&&(r.isFerie=r.holidays.find(function(e){return t(e.date).format("L")===t(r.day.date).format("L")}))}function i(e,n){r.dropCallback({$data:e,$event:n})}function o(e){var n=[];return e.forEach(function(e){n.push(r.entities.find(function(n){return n._id===e}).fullname)}),n}var r=this;r.$onInit=function(){n.extend(r,{dropEvent:i,getName:o,absents:[]}),r.isDefined=void 0===r.day.events,a(),e.$watchCollection([r.day,r.absences],function(){r.day&&r.day.date&&r.absences&&Object.keys(r.absences).length?(r.absents=Object.keys(r.absences).reduce(function(e,a){var i=r.absences[a],o=n.any(i,function(e){var n=t.range(e.start,e.end);return 0!==t(e.start).diff(e.end,"minutes")&&(12===t(e.start).hours()&&t(e.start).isSame(r.day.date,"day")?!!t(e.start).isBetween(r.day.date,t(r.day.date).endOf("day")):!!r.day.date.within(n)||void 0)});return o&&e.push(a),e},[]),r.absentsString="<div>"+r.getName(r.absents).join("<br>")+"</div>"):(r.absentsString="",r.absents=[])})}}function i(){return{restrict:"E",replace:!0,templateUrl:"/directives/planning-day-block/planning-day.html",controller:a,controllerAs:"dayCtrl",bindToController:{day:"=",events:"=",clickCallback:"&",entities:"=?",dropCallback:"&",absences:"=?",holidays:"="},scope:!0,link:function(e,n){var t=n[0];window.addEventListener("dragover",function(e){e.preventDefault()},!1),window.addEventListener("drop",function(e){e.preventDefault()},!1),t.addEventListener("drop",function(n){return n.preventDefault(),n.stopPropagation(),n.stopPropagation&&n.stopPropagation(),this.classList.remove("over"),e.$apply(function(){e.dayCtrl.dropEvent(JSON.parse(n.dataTransfer.getData("Text")),n)}),!1},!1),t.addEventListener("dragenter",function(e){return this.classList.add("over"),!1},!1),t.addEventListener("dragleave",function(e){return this.classList.remove("over"),!1},!1)}}}e.module("90Tech.planning").directive("zlPlanningDay",i),a.$inject=["$scope"]}(window.angular,window._,window.moment);var _slicedToArray=function(){function e(e,n){var t=[],a=!0,i=!1,o=void 0;try{for(var r,s=e[Symbol.iterator]();!(a=(r=s.next()).done)&&(t.push(r.value),!n||t.length!==n);a=!0);}catch(e){i=!0,o=e}finally{try{!a&&s.return&&s.return()}finally{if(i)throw o}}return t}return function(n,t){if(Array.isArray(n))return n;if(Symbol.iterator in Object(n))return e(n,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();!function(e,n,t){function a(a){function i(){o.days=[],o.allowedDays=o.usableDays,o._absences=[],"week"===o.mode?(t.forEach(o.allowedDays,function(e){var t=n(o.position);t.weekday(e),o.days.push(t)}),o.days=t.sortBy(o.days,function(e){return n(e).toDate()}),o.absences&&!function(){var t=0;o.days.forEach(function(a){o._absences[t]=[];var i=!0,r=!1,s=void 0;try{for(var l,d=Object.entries(o.absences)[Symbol.iterator]();!(i=(l=d.next()).done);i=!0){var c=_slicedToArray(l.value,2),p=(c[0],c[1]);p.forEach(function(i){(a.isBetween(n(i.start),n(i.end))||n(a).isSame(n(i.start),"day")&&n(a).isSame(n(i.end),"day"))&&o._absences[t].push(e.copy(i))})}}catch(e){r=!0,s=e}finally{try{!i&&d.return&&d.return()}finally{if(r)throw s}}t++})}()):"day"===o.mode&&o.dayField&&(o.column=o.entitiesName)}var o=this;o.$onInit=function(){a.$watchCollection(function(){return[o.events,o.position,o.mode,o.dayStart,o.dayEnd,o.usableDays,o.entitiesName]},i)}}function i(){return{restrict:"E",templateUrl:"/directives/planning-left-column/planning-left-column.html",controller:a,controllerAs:"planningLeftColumn",bindToController:{events:"=",entitiesName:"=",position:"=",mode:"=",dayField:"=",usableDays:"=",isFerie:"=?",absences:"="},scope:!0}}e.module("90Tech.planning").directive("zlPlanningLeftColumn",i),a.$inject=["$scope"]}(window.angular,window.moment,window._);var _slicedToArray=function(){function e(e,n){var t=[],a=!0,i=!1,o=void 0;try{for(var r,s=e[Symbol.iterator]();!(a=(r=s.next()).done)&&(t.push(r.value),!n||t.length!==n);a=!0);}catch(e){i=!0,o=e}finally{try{!a&&s.return&&s.return()}finally{if(i)throw o}}return t}return function(n,t){if(Array.isArray(n))return n;if(Symbol.iterator in Object(n))return e(n,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();!function(e,n,t){function a(a,i,o,r,s,l){function d(e){var n="",t=e.absenceType,a="week"===x.mode?e.user.fullname+" - ":"";switch(e.confirmation.state){case"sending":n=a+"Absence envoyée";break;case"pending":n=a+"Absence en cours de traitement";break;case"partial-accepted":n=a+"Absence en cours de traitement";break;case"accepted":n=a+"Absence acceptée"}return t?n+"\nRaison: "+t:n}function c(e){var t;return t=n.contains(e.target.classList,"half-hour")?30:Math.floor(e.offsetX/(E*x.zoom)*60)}function p(e){x.tooltip=d(e);var n=!0,t=!1,a=void 0;try{for(var i,o=document.getElementsByClassName(e._id)[Symbol.iterator]();!(n=(i=o.next()).done);n=!0){var r=i.value;r.classList.add("absence-hover")}}catch(e){t=!0,a=e}finally{try{!n&&o.return&&o.return()}finally{if(t)throw a}}}function u(){var e=!0,n=!1,t=void 0;try{for(var a,i=document.getElementsByClassName("absence")[Symbol.iterator]();!(e=(a=i.next()).done);e=!0){var o=a.value;o.classList.remove("absence-hover")}}catch(e){n=!0,t=e}finally{try{!e&&i.return&&i.return()}finally{if(n)throw t}}}function y(n,a,o){var r=parseInt(a.target.getAttribute("hour")),s=c(a),l=t(e.copy(x.position)).hours(r+parseInt(x.dayStart.h)).minutes(s),d=o.dayOfWeek?o.dayOfWeek:o.position;m(l)&&b(d)?i.warningCallback(function(){x.dropCallback({$data:n,$event:a,$hour:r+parseInt(x.dayStart.h),$minutes:s})}):m(l)&&!b(d)?i.absentTechnicianCallback(function(){x.dropCallback({$data:n,$event:a,$hour:r+parseInt(x.dayStart.h),$minutes:s})}):!m(l)&&b(d)?i.isFerieCallback(function(){x.dropCallback({$data:n,$event:a,$hour:r+parseInt(x.dayStart.h),$minutes:s})}):x.dropCallback({$data:n,$event:a,$hour:r+parseInt(x.dayStart.h),$minutes:s})}function v(n,a,o){var r=o.dayOfWeek?o.dayOfWeek:o.position,s=c(a),l=t(e.copy(x.position)).hours(n+parseInt(x.dayStart.h)).minutes(s);m(l)&&b(r)?i.warningCallback(function(){x.clickCallback({$hour:n+parseInt(x.dayStart.h),$minutes:s})}):m(l)&&!b(r)?i.absentTechnicianCallback(function(){x.clickCallback({$hour:n+parseInt(x.dayStart.h),$minutes:s})}):!m(l)&&b(r)?i.isFerieCallback(function(){x.clickCallback({$hour:n+parseInt(x.dayStart.h),$minutes:s})}):x.clickCallback({$hour:n+parseInt(x.dayStart.h),$minutes:s})}function g(){var a=0;x.preEvent={},x.postEvent={},x.breaks=[],x._events=e.copy(x.events),x.range=x.dayEnd.h-x.dayStart.h,x.SECONDS_BY_DAY=3600*x.range,x.SLIDER_WIDTH=E*x.range,x._events=n.sortBy(x._events,function(e){return e.start.valueOf()});var i=[[]],l=[];n.each(x._events,function(e){var n={};if(e.depth=1,e.range=t.range(e.start,e.end),e.range<9e5){var a=t(e.start).add(15,"minutes");e.range=t.range(e.start,a)}n.left=(e.start.hours()-x.dayStart.h)*E*x.zoom+e.start.minutes()*E*x.zoom/60+"px",n.width=x.zoom*x.SLIDER_WIDTH*e.range/x.SECONDS_BY_DAY/1e3+"px",n["background-color"]=e["background-color"]||"#778899",r.getLuminance(n["background-color"])>200?n.color="black":n.color="white",e.style=n,o.overlap(i,e,_,l)}),x._events=n.difference(x._events,l),n.each(x._events,function(o){if(o.id=e.copy(a),o.line===_&&(o.style.left=(o.start.hours()-x.dayStart.h)*E*x.zoom+o.start.minutes()*E*x.zoom/60+"px",o.style.width=x.zoom*x.SLIDER_WIDTH*o.range.valueOf()/x.SECONDS_BY_DAY/1e3+"px",o.style["background-color"]="#000",o.style["font-weight"]="bold",o.style.color="#fff",o.title=o.eventList.length+" "+S,o.tooltip&&(o.tooltip=o.title)),o.style.width=x.zoom*x.SLIDER_WIDTH*o.range.valueOf()/x.SECONDS_BY_DAY/1e3+"px",void 0===o.line&&(o.line=_),o.style.top=Math.round(70*parseInt(o.line)/i.length)+"%",o.style.height=Math.round(70/i.length)+"%",o.percentage="100%",o.pre>0){o.style["border-left"]="none";var r=t(o.start).subtract(o.pre,"minutes");t(r).isSame(o.start,"day")||(r=t(o.start).startOf("day"));var l=t(o.start),d=t.range(r,l),c=t.range(r,o.range.end),p=d.valueOf()/c.valueOf()*100;o.percentage=100-p+"%";var u={percentage:p+"%",style:{left:(t(r).hours()-x.dayStart.h)*E*x.zoom+t(r).minutes()*E*x.zoom/60+2+"px",width:x.zoom*x.SLIDER_WIDTH*d.valueOf()/x.SECONDS_BY_DAY/1e3+"px",top:o.style.top,height:o.style.height,totalWidth:x.zoom*x.SLIDER_WIDTH*c.valueOf()/x.SECONDS_BY_DAY/1e3+"px","text-align":"center",color:"#fff",background:"repeating-linear-gradient(45deg, "+o["background-color"]+", "+o["background-color"]+" 10px, white 10px, white 20px)","border-top":"1px lightgrey solid","border-bottom":"1px lightgrey solid","border-left":"1px lightgrey solid"},tooltip:"Trajet estimé de "+o.pre+" min"};p>0?x.preEvent[o.id]=u:o.pre=0}k(o),o.pauses&&(o.style["background-image"]=s.generateGradient(o,"to right"),o.style["background-color"]=void 0);var y=x.preEvent[o.id],v=x.postEvent[o.id];o.style.totalWidth=w(o.style.width)+w(n.get(y,"style.width"))+w(n.get(v,"style.width"))+1+"px",a++}),x.pauses&&h()}function f(e){return parseInt(e)*E+"px"}function h(){x.breaks=n.compact(n.map(x.pauses.breaks,function(n){var a={name:n.name,start:t().hours(n.start.split(":")[0]).minute(n.start.split(":")[1]).second(0),end:t().hours(n.end.split(":")[0]).minute(n.end.split(":")[1]).second(0),style:{}};if(!a.start.isAfter(x.dayEnd)&&!a.end.isBefore(x.dayStart))return a.start.isBefore(x.dayStart)&&(a.start=t(e.copy(x.dayStart))),a.end.isAfter(x.dayEnd)&&(a.end=t(e.copy(x.dayEnd))),a.style.left=(a.start.hours()-x.dayStart.h)*E*x.zoom+a.start.minutes()*E*x.zoom/60+"px",a.style.width=x.zoom*x.SLIDER_WIDTH*t.range(a.start,a.end).valueOf()/x.SECONDS_BY_DAY/1e3+"px",a}))}function m(a){if("week"===x.mode)return!1;var i=t(e.copy(a));return n.any(x._absences,function(e){return e.range.contains(i)})}function b(e){return x.holidays.find(function(n){return t(n.date).format("L")===t(e).format("L")})}function k(e){if(!e.post)return null;e.style["border-right"]="none";var n=t(e.end).add(e.post,"minutes");t(n).isSame(e.end,"day")||(n=t(e.end).endOf("day"));var a=t(e.end),i=t.range(a,n),o=t.range(e.range.start,e.range.end),r=i.valueOf()/o.valueOf()*100;e.postPercentage=100-r+"%";var s={percentage:r+"%",style:{left:(t(a).hours()-x.dayStart.h)*E*x.zoom+t(a).minutes()*E*x.zoom/60+2+"px",width:x.zoom*x.SLIDER_WIDTH*i.valueOf()/x.SECONDS_BY_DAY/1e3+"px",top:e.style.top,height:e.style.height,totalWidth:x.zoom*x.SLIDER_WIDTH*o.valueOf()/x.SECONDS_BY_DAY/1e3+"px","text-align":"center",color:"#fff",background:"repeating-linear-gradient(135deg, "+e["background-color"]+", "+e["background-color"]+" 10px, white 10px, white 20px)","border-top":"1px lightgrey solid","border-bottom":"1px lightgrey solid","border-left":"1px lightgrey solid"},tooltip:"Trajet retour de "+e.post+" min"};r>0?x.postEvent[e.id]=s:e.post=0}function w(){var e=arguments.length<=0||void 0===arguments[0]?"0px":arguments[0];return parseInt(e.replace("px",""))}var E=i.BASE_SIZE,S=i.parallelText,_=i.MAX_PARALLEL,x=this;x.$onInit=function(){n.extend(x,{clickEvent:v,calcWidth:f,dropEvent:y,hoverAbsence:p,leaveAbsence:u}),g(),a.$watchCollection(function(){return[x.events,x.dayStart,x.dayEnd]},g),a.$watchCollection(function(){return[x.absences]},function(n,a){if(Array.isArray(x.absences)&&x.absences.length){var i=t(e.copy(x.position)).startOf("day"),o=t(e.copy(x.position)).endOf("day");x._absences=l.parseAbsences(x.absences,[i,o]).map(function(e){return e.style={left:(t(e.start).hours()-x.dayStart.h)*E*x.zoom+t(e.start).minutes()*E*x.zoom/60+"px",width:x.zoom*x.SLIDER_WIDTH*t.range(e.start,e.end).valueOf()/x.SECONDS_BY_DAY/1e3+"px"},e.range=t.range(e.start,e.end),e.class="planning-absence-"+e.confirmation.state,e.tooltip=d(e),e})}else if(x.absences){var i=t(e.copy(x.dayOfWeek)).startOf("day"),o=t(e.copy(x.dayOfWeek)).endOf("day");x._absences=[];var r=!0,s=!1,c=void 0;try{for(var p,u=Object.entries(x.absences)[Symbol.iterator]();!(r=(p=u.next()).done);r=!0){var y=_slicedToArray(p.value,2),v=(y[0],y[1]);v.forEach(function(n){(x.dayOfWeek.isBetween(t(n.start),t(n.end))||t(x.dayOfWeek).isSame(t(n.start),"day")&&t(x.dayOfWeek).isSame(t(n.end),"day"))&&x._absences.push(e.copy(n))})}}catch(e){s=!0,c=e}finally{try{!r&&u.return&&u.return()}finally{if(s)throw c}}x._absences.forEach(function(e){var n=x._absences.indexOf(e);(t(e.start).isBefore(t(x.dayOfWeek).startOf("day"))&&t(e.end).isAfter(t(x.dayOfWeek).endOf("day"))||t(e.end).isSame(t(x.dayOfWeek).endOf("day"))&&t(e.start).isBefore(t(x.dayOfWeek).startOf("hour"))||t(e.start).isSame(t(x.dayOfWeek).startOf("day"))&&t(e.end).isAfter(t(x.dayOfWeek).endOf("day")))&&(e.start=t(x.dayOfWeek).startOf("day"),e.end=t(x.dayOfWeek).endOf("day")),e.style={left:(t(e.start).hours()-x.dayStart.h)*E*x.zoom+t(e.start).minutes()*E*x.zoom/60+"px",width:x.zoom*x.SLIDER_WIDTH*t.range(e.start,e.end).valueOf()/x.SECONDS_BY_DAY/1e3+"px",height:100/x._absences.length+"%",position:"absolute",top:100/x._absences.length*n+"%"},e.range=t.range(e.start,e.end),e.class="planning-absence-"+e.confirmation.state,e.tooltip=d(e),e.index=n})}else x._absences=[]})},x.log=function(e){},x.replace=function(e){if(e)return e.replace(/([a-zA-Z\ ])\w+/,"")},x.preEvent={},x.postEvent={}}function i(){return{restrict:"E",templateUrl:"/directives/planning-line/planning-line.html",controller:a,controllerAs:"line",bindToController:{zoom:"=",dayStart:"=",dayEnd:"=",events:"=",clickCallback:"&",dropCallback:"&",pauses:"=?",absences:"=?",position:"=?",mode:"=?",entities:"=?",dayOfWeek:"=",holidays:"="},scope:!0}}e.module("90Tech.planning").directive("zlPlanningLine",i),a.$inject=["$scope","planningConfiguration","PositionService","ColorService","PauseService","AbsenceService"]}(window.angular,window._,window.moment),function(e,n,t){function a(e){function a(e){function a(){var e=s.dayEnd.h-s.dayStart.h+1;s.hours=[],t.times(e,function(e){var t=n(s.position);t.hour(e+parseInt(s.dayStart.h)),t.minute(0),s.hours.push(t)})}function o(e){return parseInt(e)*i+"px"}function r(e,n){var t=parseInt(e)*(i/2);return n||(t-=3*parseInt(e)),"0 "+t+"px 0 -"+t+"px"}var s=this;s.$onInit=function(){e.$watchGroup([function(){return s.dayStart},function(){return s.dayEnd;
}],a),t.extend(s,{calcWidth:o,calcMargin:r}),a()}}var i=e.BASE_SIZE;return{restrict:"E",templateUrl:"/directives/planning-top-row/planning-top-row.html",controller:["$scope",a],controllerAs:"planningTopRow",bindToController:{zoom:"=",dayStart:"=",dayEnd:"=",events:"=",entities:"=",position:"=",mode:"=",callback:"&",holidays:"="},scope:{}}}e.module("90Tech.planning").directive("zlPlanningTopRow",a),a.$inject=["planningConfiguration"]}(window.angular,window.moment,window._),function(e,n,t){function a(a,i,o,r,s,l,d){function c(e){var n="",t=e.absenceType;switch(e.confirmation.state){case"sending":n="Absence envoyée";break;case"pending":n="Absence en cours de traitement";break;case"partial-accepted":n="Absence en cours de traitement";break;case"accepted":n="Absence acceptée"}return t?n+"\nRaison:"+t:n}function p(e){var t;return t=n.contains(e.target.classList,"half-hour")?30:10*Math.floor(e.offsetY/(_*C.zoom)*6)}function u(n,a,i){var r=parseInt(a.target.getAttribute("hour")),s=p(a),l=t(e.copy(C.day)).hours(r+parseInt(C.dayStart.h)).minutes(s),d=i;E(l)&&S(d)?o.warningCallback(function(){C.dropCallback({$data:n,$event:a,$hour:r,$minutes:s})}):E(l)&&!S(d)?o.absentTechnicianCallback(function(){C.dropCallback({$data:n,$event:a,$hour:r,$minutes:s})}):!E(l)&&S(d)?o.isFerieCallback(function(){C.dropCallback({$data:n,$event:a,$hour:r,$minutes:s})}):C.dropCallback({$data:n,$event:a,$hour:r,$minutes:s})}function y(){var e=!0,n=!1,t=void 0;try{for(var a,i=document.getElementsByClassName("absence")[Symbol.iterator]();!(e=(a=i.next()).done);e=!0){var o=a.value;o.classList.add("absence-week-advanced-hover")}}catch(e){n=!0,t=e}finally{try{!e&&i.return&&i.return()}finally{if(n)throw t}}}function v(){var e=!0,n=!1,t=void 0;try{for(var a,i=document.getElementsByClassName("absence")[Symbol.iterator]();!(e=(a=i.next()).done);e=!0){var o=a.value;o.classList.remove("absence-week-advanced-hover")}}catch(e){n=!0,t=e}finally{try{!e&&i.return&&i.return()}finally{if(n)throw t}}}function g(n,a,i){var r=p(a),s=t(e.copy(C.day)).hours(n+parseInt(C.dayStart.h)).minutes(r);E(s)&&S(i)?o.warningCallback(function(){C.clickCallback({$hour:n+parseInt(C.dayStart.h),$minutes:r})}):E(s)&&!S(i)?o.absentTechnicianCallback(function(){C.clickCallback({$hour:n+parseInt(C.dayStart.h),$minutes:r})}):!E(s)&&S(i)?o.isFerieCallback(function(){C.clickCallback({$hour:n+parseInt(C.dayStart.h),$minutes:r})}):C.clickCallback({$hour:n+parseInt(C.dayStart.h),$minutes:r})}function f(){var a=0;C.preEvent={},C.breaks=[],C._events=e.copy(C.events),C.range=C.dayEnd.h-C.dayStart.h,C.SECONDS_BY_DAY=3600*C.range,C.SLIDER_WIDTH=_*C.range,C._events=n.sortBy(C._events,function(e){return e.start.valueOf()});var i=[[]],o=[];n.each(C._events,function(e){var n={};if(e.depth=1,e.range=t.range(e.start,e.end),e.range<9e5){var a=t(e.start).add(15,"minutes");e.range=t.range(e.start,a)}n.left=(e.start.hours()-C.dayStart.h)*_*C.zoom+e.start.minutes()*_*C.zoom/60+"px",n.width=C.zoom*C.SLIDER_WIDTH*e.range/C.SECONDS_BY_DAY/1e3+"px",n["background-color"]=e["background-color"]||"#778899",s.getLuminance(n["background-color"])>200?n.color="black":n.color="white",e.style=n,r.overlap(i,e,$,o)}),C._events=n.difference(C._events,o),n.each(C._events,function(o){if(o.id=e.copy(a),o.line===$&&(o.style.left=(o.start.hours()-C.dayStart.h)*_*C.zoom+o.start.minutes()*_*C.zoom/60+"px",o.style.width=C.zoom*C.SLIDER_WIDTH*o.range.valueOf()/C.SECONDS_BY_DAY/1e3+"px",o.style["background-color"]="#000",o.style["font-weight"]="bold",o.title=o.eventList.length+" "+x,o.style.color="#fff",o.tooltip&&(o.tooltip=o.title)),o.style.width=C.zoom*C.SLIDER_WIDTH*o.range.valueOf()/C.SECONDS_BY_DAY/1e3+"px",void 0===o.line&&(o.line=$),o.style.top=Math.round(parseInt(o.line)*D/i.length)+"%",o.style.height=Math.round(D/i.length)+"%",o.percentage="100%",o.continuedBefore&&(o.pre=0),o.pre>0){o.style["border-left"]="none";var r=t(o.start).subtract(o.pre,"minutes");t(r).isSame(o.start,"day")||(r=t(o.start).startOf("day"));var s=t(o.start),d=t.range(r,s),c=t.range(r,o.range.end),p=d.valueOf()/c.valueOf()*100;o.percentage=100-p+"%";var u={percentage:p+"%",style:{left:(t(r).hours()-C.dayStart.h)*_*C.zoom+t(r).minutes()*_*C.zoom/60+"px",width:C.zoom*C.SLIDER_WIDTH*d.valueOf()/C.SECONDS_BY_DAY/1e3+"px",top:o.style.top,height:o.style.height,totalWidth:C.zoom*C.SLIDER_WIDTH*c.valueOf()/C.SECONDS_BY_DAY/1e3+"px","text-align":"center",color:"#fff",background:"repeating-linear-gradient(45deg, "+o["background-color"]+", "+o["background-color"]+" 10px, white 10px, white 20px)","border-top":"1px lightgrey solid","border-bottom":"1px lightgrey solid","border-left":"1px lightgrey solid"},tooltip:"Trajet estimé de "+o.pre+" min"};p>0?C.preEvent[o.id]=u:o.pre=0}m(o),o.pauses&&(o.style["background-image"]=l.generateGradient(o,"to bottom"),o.style["background-color"]=void 0);var y=C.preEvent[o.id],v=C.postEvent[o.id];o.style.totalWidth=h(o.style.width)+h(n.get(y,"style.width"))+h(n.get(v,"style.width"))+1+"px",a++}),C.pauses&&k(),w()}function h(){var e=arguments.length<=0||void 0===arguments[0]?"0px":arguments[0];return parseInt(e.replace("px",""))}function m(e){if(!e.post)return null;var n=t(e.end).add(e.post,"minutes");t(n).isSame(e.end,"day")||(n=t(e.end).endOf("day"));var a=t(e.end),i=t.range(a,n),o=t.range(e.range.start,e.range.end),r=i.valueOf()/o.valueOf()*100;e.postPercentage=100-r+"%";var s={percentage:r+"%",style:{left:(t(a).hours()-C.dayStart.h)*_*C.zoom+t(a).minutes()*_*C.zoom/60+2+"px",width:C.zoom*C.SLIDER_WIDTH*i.valueOf()/C.SECONDS_BY_DAY/1e3+"px",top:e.style.top,height:e.style.height,totalWidth:C.zoom*C.SLIDER_WIDTH*o.valueOf()/C.SECONDS_BY_DAY/1e3+"px","text-align":"center",color:"#fff",background:"repeating-linear-gradient(135deg, "+e["background-color"]+", "+e["background-color"]+" 10px, white 10px, white 20px)","border-top":"1px lightgrey solid","border-bottom":"1px lightgrey solid","border-left":"1px lightgrey solid"},tooltip:"Trajet retour de "+e.post+" min"};r>0?C.postEvent[e.id]=s:e.post=0}function b(e){return parseInt(e)*_+"px"}function k(){C.breaks=n.compact(n.map(C.pauses.breaks,function(n){var a={name:n.name,start:t().hours(n.start.split(":")[0]).minute(n.start.split(":")[1]).second(0),end:t().hours(n.end.split(":")[0]).minute(n.end.split(":")[1]).second(0),style:{}};if(!a.start.isAfter(C.dayEnd)&&!a.end.isBefore(C.dayStart))return a.start.isBefore(C.dayStart)&&(a.start=t(e.copy(C.dayStart))),a.end.isAfter(C.dayEnd)&&(a.end=t(e.copy(C.dayEnd))),a.style.top=(t(a.start).hours()-C.dayStart.h)*_*C.zoom+t(a.start).minutes()*_*C.zoom/60+"px",a.style.height=C.zoom*C.SLIDER_WIDTH*t.range(a.start,a.end).valueOf()/C.SECONDS_BY_DAY/1e3+"px",a}))}function w(){C.containerHeight=parseInt(C.zoom)*_*a("range")(C.range)+"px"}function E(a){var i=t(e.copy(a));return n.any(C._absences,function(e){return e.range.contains(i)})}function S(e){return C.holidays.find(function(n){return t(n.date).format("L")===t(e).format("L")})}var _=Math.max(o.BASE_SIZE-8,1),x=o.parallelText,$=o.MAX_PARALLEL,D=90,C=this;C.$onInit=function(){C.range=C.dayEnd.h-C.dayStart.h,C.SECONDS_BY_DAY=3600*C.range,C.SLIDER_WIDTH=_*C.range,i.$watchCollection(function(){return[C.events,C.dayStart,C.dayEnd]},f),i.$watchCollection(function(){return C.absences},function(n,a){if(Array.isArray(C.absences)&&C.absences.length){var i=t(e.copy(C.day)).startOf("day"),o=t(e.copy(C.day)).endOf("day");C._absences=d.parseAbsences(e.copy(C.absences),[i,o]).map(function(e){var n=(t(e.start).hours()-C.dayStart.h)*_*C.zoom+t(e.start).minutes()*_*C.zoom/60,a=C.zoom*C.SLIDER_WIDTH*t.range(e.start,e.end).valueOf()/C.SECONDS_BY_DAY/1e3;return"0px"===e.style.top?e.style.height=n+a+"px":(e.style.height=a+"px",e.style.top=n+"px"),e.range=t.range(e.start,e.end),e.class="planning-absence-"+e.confirmation.state,e.tooltip=c(e),e})}else C._absences=[]}),n.extend(C,{clickEvent:g,calcWidth:b,dropEvent:u,hoverAbsence:y,leaveLine:v}),f()},C.log=function(e){},C.replace=function(e){if(e)return e.replace(/([a-zA-Z\ ])\w+/,"")},C.preEvent={},C.postEvent={}}function i(){return{restrict:"E",templateUrl:"/directives/planning-vertical-line/planning-vertical-line.html",controller:a,controllerAs:"line",bindToController:{zoom:"=",dayStart:"=",dayEnd:"=",events:"=",pauses:"=?",day:"=",absences:"=?",holidays:"=?",clickCallback:"&",dropCallback:"&"},scope:!0}}e.module("90Tech.planning").directive("zlPlanningVerticalLine",i),a.$inject=["$filter","$scope","planningConfiguration","PositionService","ColorService","PauseService","AbsenceService"]}(window.angular,window._,window.moment),function(e,n,t){function a(e,a,i,o){function r(){p.displayedEvents=t(p.events).sortBy(function(e){return e.continuedBefore?-1:e.continuedAfter?0:1}).value(),p.displayedEvents=s(p.displayedEvents),p.oneDayEvents=s(p.oneDayEvents)}function s(e){var i=[[]],o=[];return t.each(e,function(e){e.style={},e.depth=1,e.range=n.range(e.start,e.end),a.overlap(i,e,y,o,!0)}),e=t.difference(e,o),t.each(e,function(e){l(e,i.length)}),e}function l(e,n){e.style.left=c(e),e.style.width=d(e),e.style["background-color"]=e["background-color"],o.getLuminance(e.style["background-color"])>200?e.style.color="black":e.style.color="white",e.style.top=Math.ceil(100*e.line/n)+"%",e.style.height=Math.round(100/n)+"%",void 0===e.line&&(e.line=y),e.eventList&&e.eventList.length>1&&(e.style["background-color"]="#000",e.style.color="#FFF",e.style["font-weight"]="bold",e.title=e.eventList.length+" "+u,e.tooltip&&(e.tooltip=e.title))}function d(e){if(e.start.day()===e.end.day())return(e.end.diff(e.start,"days")+1)*(100/7)+"%";var n=Math.ceil(e.end.diff(e.start,"hours")/24);return e.end.hours()<e.start.hours()&&(n+=1),n*(100/7)+"%"}function c(e){return(e.start.isoWeekday()-1)*(99.9/7)+"%"}var p=this;p.$onInit=function(){t.extend(p,{calculateWidth:d,calculateLeft:c}),r(),e.$watchCollection(function(){return[p.events,p.week]},r)};var u=i.parallelText,y=i.MAX_PARALLEL}function i(){return{restrict:"E",replace:!0,templateUrl:"/directives/planning-week-line/planning-week-line.html",controller:a,controllerAs:"line",bindToController:{events:"=",week:"=",oneDayEvents:"=",weekEventCallback:"&"},scope:!0}}e.module("90Tech.planning").directive("zlPlanningWeekLine",i),a.$inject=["$scope","PositionService","planningConfiguration","ColorService"]}(window.angular,window.moment,window._),angular.module("90Tech.planning").run(["$templateCache",function(e){e.put("/templates/planning-context-menu.html",'<ul class="dropdown-menu context-menu" ng-click=$event.stopPropagation(); style="z-index: 10"><li ng-if="!event.eventList.length && !ev.eventList.length"><a ng-click="planning.action({$element: event || ev})"><i class="mdi mdi-chevron-down"></i> Ouvrir dans un nouvel onglet {{event.eventList.length}}</a></li><li ng-if="!event.eventList.length && !ev.eventList.length"><a ng-click="planning.duplicateAction({$element: event || ev})"><i class="mdi mdi-chevron-down"></i> Dupliquer l\'intervention {{event.eventList.length}}</a></li></ul>'),e.put("/directives/planning-day-block/planning-day.html",'<div class=day-block ng-class="{\'empty-day\': dayCtrl.isDefined }" ng-click=planning.dayCallback({$day:dayCtrl.day.date})><div style=position:absolute;left:5px;top:5px; ng-if="dayCtrl.day.date.day() === 1">{{dayCtrl.day.date.week()}}</div><div class=day-number>{{ dayCtrl.day.date.date() }}</div><span ng-if=dayCtrl.isFerie class=holidays>férié</span><div class=events-container><div ng-style="{\'background-color\': event.color}" class=month-event ng-repeat="event in dayCtrl.day.events |limitTo:5">{{event.title}}</div></div><div class=absents-container tooltip-append-to-body=true ng-if=dayCtrl.absents.length uib-tooltip-html=dayCtrl.absentsString>{{dayCtrl.absents.length}} absent(s)</div></div>'),e.put("/directives/planning/planning.html",'<div ng-if="planning.mode ===\'day\' || planning.mode === \'week\'" style="height: 100%;"><zl-planning-left-column mode=planning.mode position=planning.position day-field=planning.dayField entities-name=planning.entitiesName , usable-days=planning.allowedDays show-absences-callback="planning.showAbsencesCallBackWrapper({absences: absences, day: day})" events=planning.sortedEvents absences=planning.absences is-ferie=planning.isFerie(planning.position)></zl-planning-left-column><div class style=height:100%><div zl-horizontal-scroll scroll-left=planning.currentTimeToPixels() style=height:100%><div ng-style="{width: planning.width}" class=planning-body><zl-planning-top-row mode=planning.mode zoom=planning.zoom position=planning.position holidays=planning.holidays day-start=planning._dayStart day-end=planning._dayEnd></zl-planning-top-row><div class=hour-cursor ng-style="{left: planning.currentTimeToPixels()+\'px\'}" ng-if="planning.isCurrent() && planning.isInDayRange()"><div class=hour-caret></div></div><div ng-if=planning.isFerie(planning.position)></div><div class=planning-2pc ng-class="{isFerie: (planning.mode === \'day\' && planning.isFerie(planning.position))}"></div><zl-planning-line ng-if="planning.mode === \'day\'" zoom=planning.zoom absences=planning.absences[i] position=planning.position day-start=planning._dayStart day-end=planning._dayEnd ng-repeat="i in planning.keys(planning.sortedEvents)" class="day b-b" ng-class="{today: planning.isToday(i)}" events=planning.getEvents(i) pauses=planning.entitiesPauses[i][0] holidays=planning.holidays drop-callback="planning.dropEvent({h: $hour, m: $minutes, d: i, entity: i, $data: $data, $event: $event})" click-callback="planning.clickCallbackWrapper({h: $hour, m: $minutes, d: i, entity: i})"></zl-planning-line><zl-planning-line ng-if="planning.mode === \'week\'" zoom=planning.zoom ng-repeat="day in planning.usableDays" position=planning.position entities=planning.entities day-of-week=planning.daysList[day] mode=planning.mode holidays=planning.holidays day-start=planning._dayStart day-end=planning._dayEnd class="day b-b" ng-class="{today: planning.isToday(planning.keys(planning.sortedEvents)[day])}" events=planning.getEvents(planning.keys(planning.sortedEvents)[day]) drop-callback="planning.dropEvent({h: $hour, m: $minutes, d: planning.keys(planning.sortedEvents)[day], entity: planning.keys(planning.sortedEvents)[day], $data: $data, $event: $event})" click-callback="planning.clickCallbackWrapper({h: $hour, m: $minutes, d: planning.keys(planning.sortedEvents)[day], entity: planning.keys(planning.sortedEvents)[day]})"></zl-planning-line></div></div></div></div><div ng-if="planning.mode === \'3day\'" style="height: 100%;"><zl-planning-left-column mode="\'day\'" position=planning.position entities-name=planning.entitiesName day-field=planning.dayField usable-days=planning.allowedDays events=planning.sortedEvents></zl-planning-left-column><div style="height: 100%; display: flex; flex-flow: row nowrap;" zl-horizontal-scroll><div style=height:100%; ng-repeat="day in planning.groupedEvents track by $index"><div style="height:100%; display: inline-block;"><div ng-style="{width: planning.width}" class=planning-body><zl-planning-top-row mode="\'day\'" zoom=planning.zoom position=planning.position day-start=planning._dayStart day-end=planning._dayEnd></zl-planning-top-row><p style="position: absolute; top: 27px; font-size: 1.4em; font-weight: bold; width: 100%; padding-left: 5px;" ng-class="{isFerie: planning.isFerie(day.date)}">{{day.day}}<span class=holidays ng-if=planning.isFerie(day.date)>férié</span></p><div class=hour-cursor ng-style="{left: planning.currentTimeToPixels()+\'px\'}" ng-if="planning.isCurrent() && planning.isInDayRange()"><div class=hour-caret></div></div><div class=planning-2pc></div><zl-planning-line zoom=planning.zoom position=day.date absences=day.absences[i] day-start=planning._dayStart day-end=planning._dayEnd ng-repeat="i in planning.keys(day.value) track by $index" class="day b-b" events=day.value[i] pauses=planning.entitiesPauses[i][$parent.$index] holidays=planning.holidays drop-callback="planning.dropEvent({h: $hour, m: $minutes, d: i, entity: i, $data: $data, $event: $event, day: day.key})" click-callback="planning.clickCallbackWrapper({h: $hour, m: $minutes, d: i, entity: i})"></zl-planning-line></div></div></div></div></div><div ng-if="planning.mode ===\'week-advanced\'" class=advanced-week><div class=days-list><div class=day-advanced>&nbsp;</div><div class=day-advanced ng-repeat="day in planning.daysList" ng-click=planning.dayCallback({$day:day}) ng-class="{isFerie: planning.isFerie(day)}"><span class=day-text>{{day | format:\'dddd\' | capitalize}}<br><small>{{day | format:\'ll\'}}</small> <span class=holidays ng-if=planning.isFerie(day)>férié</span></span></div></div><div class=advanced-week-container ng-repeat="name in planning.keys(planning.sortedEvents)"><div class=left-column-advanced><span style=margin:auto>{{planning.getName(name)}}</span></div><div ng-repeat="day in planning.allowedDays" style="overflow: hidden;" class=day-advanced><zl-planning-vertical-line day=planning.daysList[$index] zoom=planning.zoom drop-callback="planning.dropEvent({h: $hour, m: $minutes, d:day, entity: name, $data: $data, $event: $event})" day-start=planning._dayStart day-end=planning._dayEnd events=planning.getEvents(name)[day] pauses=planning.entitiesPauses[name][$index] absences=planning.absences[name] holidays=planning.holidays click-callback="planning.clickCallbackWrapper({h: $hour, m: $minutes, d: day, entity: name})"></zl-planning-vertical-line></div></div></div><div ng-if="planning.mode === \'month\'" style="height: 100%; z-index: 1000;"><div class=month-header><span class=month-text>{{planning.month | capitalize}}</span></div><div class=day-header><div class=day ng-repeat="day in []|range:7"><span class=day-text>{{day | day}}</span></div></div><div class=month-container><zl-planning-day ng-repeat="day in planning.days" day=day events=planning._events absences=planning.absences drop-callback="planning.dropEvent({$data: $data, $event: $event, moment: day.date})" entities=planning.entitiesName ng-dblclick="planning.clickWeekEvent(day, $event)" holidays=planning.holidays></zl-planning-day><zl-planning-week-line ng-repeat="(week, events) in planning.multipleDaysEvents" events=events week=week one-day-events=planning.oneDayEvents[week] style="height: 20%; pointer-events: none"></zl-planning-week-line></div></div>'),e.put("/directives/planning-line/planning-line.html",'<div ng-style="{height: line.containerHeight}"><div style="position: absolute; height: 100%; width: 100%; z-index: 1" zl-planning-drag-drop zl-drop="line.dropEvent($data, $event, line)"><div class="b-b b-r all-day day-hour" ng-dblclick="line.clickEvent(n, $event, line)" ng-mouseleave=line.leaveAbsence() uib-tooltip={{line.tooltip}} tooltip-append-to-body=true tooltip-placement=top ng-style="{width: line.calcWidth(line.zoom)}" ng-repeat="n in [] | range:line.range" hour={{n}}><span class=half-hour></span></div></div><div ng-repeat="absence in line._absences track by $index" ng-mouseenter=line.hoverAbsence(absence) id={{absence._id}} class="{{absence.class}} absence {{absence._id}}" tooltip-append-to-body=true tooltip-placement=top uib-tooltip={{absence.tooltip}} data-html=true style="height: 100%" ng-style=absence.style></div><div ng-repeat="event in line._events" zl-planning-drag-drop ng-click="planning.eventCallback({\'event\':event})" zl-drag=event ng-style="{ height: event.style.height, top: event.style.top, width: event.style.totalWidth, left: event.pre > 0 ? line.preEvent[event.id].style.left : event.style.left }" style="position: absolute; z-index: 3; display: flex; flex-flow: row nowrap"><div ng-if="event.pre > 0" ng-style="{width: line.preEvent[event.id].style.width, \'background\': line.preEvent[event.id].style[\'background\']}" style="display: inline-block; position: relative; height: 100%; text-align: center; color: white; border: 1px lightgrey solid; border-right: none;" class=pre-event tooltip-append-to-body=true uib-tooltip={{line.preEvent[event.id].tooltip}}><div class=title-container><span><i style="height: 100%; font-size: 1.2em;" class="mdi mdi-car"></i></span></div></div><div class=event style="display: inline-block; position: relative; height: 100%;" data-context-menu=/templates/planning-context-menu.html tooltip-append-to-body=true tooltip-placement="{{event.tooltipTemplate? \'auto\': \'top\'}}" ng-attr-uib-tooltip="{{!event.tooltipTemplate ? event.tooltip : undefined}}" ng-attr-uib-tooltip-template="{{\'\' + event.tooltipTemplate}}" tooltip-class=planning-event-tooltip ng-style="{ width: event.style.width, background: event.style[\'background-color\'], \'background-image\': event.style[\'background-image\'], color: event.style.color, \'border-left\': event.pre > 0 ? \'none\': \'\' }"><div class=event-line-container style><div class=event-line ng-style="{\'background-color\': event.color}" ng-if=!event.continuedBefore></div></div><div class=title-container><span>{{event.title}}</span></div></div><div ng-if="event.post > 0" ng-style="{width: line.postEvent[event.id].style.width, \'background\': line.postEvent[event.id].style[\'background\']}" style="display: inline-block; position: relative; height: 100%; text-align: center; color: white; border: 1px lightgrey solid; border-right: none;" class=pre-event tooltip-append-to-body=true uib-tooltip={{line.postEvent[event.id].tooltip}}><div class=title-container><span><i style="height: 100%; font-size: 1.2em;" class="mdi mdi-car"></i></span></div></div></div><div ng-repeat="pause in line.breaks track by $index" class=planning-pause-element style="height: 100%;" ng-style=pause.style></div></div>'),e.put("/directives/planning-top-row/planning-top-row.html",'<div class=planning-top-row><div ng-repeat="hour in planningTopRow.hours" class=day-hour ng-style="{width: planningTopRow.calcWidth(planningTopRow.zoom), margin: planningTopRow.calcMargin(planningTopRow.zoom, $index)}"><h4>{{hour | format:\'HH:mm\'}}</h4></div></div>'),e.put("/directives/planning-vertical-line/planning-vertical-line.html",'<div ng-style="{height: line.containerHeight}"><div style="position: absolute; height: 100%; width: 100%; z-index: 1" ng-mouseleave=line.leaveLine()><div ng-repeat="n in [] | range: line.range" style="display: flex; z-index: 1"><div style="display: flex; align-items: flex-end;"><span class=hour-text>{{n + 1 + line.dayStart.h}}</span></div><div style="width: 100%;" class="b-b b-r all-day" ng-style="{height: line.calcWidth(line.zoom)}" ng-dblclick="line.clickEvent(n, $event, line.day)" hour="{{n + line.dayStart.h}}" zl-planning-drag-drop zl-drop="line.dropEvent($data, $event, line.day)"></div></div></div><div ng-repeat="event in line._events" zl-planning-drag-drop ng-click="planning.eventCallback({\'event\':event})" zl-drag=event ng-style="{ width: event.style.height, right: event.style.top, height: event.pre > 0 ? line.preEvent[event.id].style.totalWidth : event.style.width, top: event.pre > 0 ? line.preEvent[event.id].style.left : event.style.left }" style="position: absolute; z-index: 2;"><div ng-if="event.pre > 0" ng-style="{height: line.preEvent[event.id].style.width, \'background\': line.preEvent[event.id].style[\'background\']}" style="display: flex; position: relative; width: 100%; text-align: center; color: white; border: 1px lightgrey solid; border-right: none;" class=pre-event tooltip-append-to-body=true uib-tooltip={{line.preEvent[event.id].tooltip}}><div class=title-container><span><i style="width: 100%; font-size: 1.2em;" class="mdi mdi-car"></i></span></div></div><div class=event style="display: flex; position: relative; width: 100%;" tooltip-append-to-body=true tooltip-placement="{{event.tooltipTemplate? \'auto\': \'top\'}}" ng-attr-uib-tooltip="{{!event.tooltipTemplate ? event.tooltip : undefined}}" ng-attr-uib-tooltip-template="{{\'\' + event.tooltipTemplate}}" tooltip-class=planning-event-tooltip data-context-menu=/templates/planning-context-menu.html ng-style="{ height: event.style.width, overflow: \'hidden\', \'background-image\': event.style[\'background-image\'], background: event.style[\'background-color\'], color: event.style.color, \'border-left\': event.pre > 0 ? \'none\': \'\' }"><div class=event-line-container style><div class=event-line ng-style="{\'background-color\': event.color}"></div></div><div class=title-container><span>{{event.title}}</span></div></div><div ng-if="event.post > 0" ng-style="{height: line.postEvent[event.id].style.width, \'background\': line.postEvent[event.id].style[\'background\']}" style="display: inline-block; position: relative; width: 100%; text-align: center; color: white; border: 1px lightgrey solid; border-right: none;" class=pre-event tooltip-append-to-body=true uib-tooltip={{line.postEvent[event.id].tooltip}}><div class=title-container><span><i style="width: 100%; font-size: 1.2em;" class="mdi mdi-car"></i></span></div></div></div><div ng-repeat="pause in line.breaks track by $index" class=planning-pause-element style="width: 95%; left: 5%;" ng-style=pause.style></div><div ng-repeat="absence in line._absences track by $index" id={{absence._id}} class="{{absence.class}} absence {{absence._id}}" ng-mouseover=line.hoverAbsence(absence) tooltip-append-to-body=true tooltip-placement=top tooltip-classes=absence-tooltip uib-tooltip={{absence.tooltip}} style="width: 95%; left: 5%;" ng-style=absence.style></div></div>'),e.put("/directives/planning-left-column/planning-left-column.html",'<div class=left-column ng-switch=planningLeftColumn.mode><div class=planning-head></div><div class=left-body><div class=planning-2pc><span class=holidays ng-if="planningLeftColumn.isFerie && (planningLeftColumn.mode === \'day\' || planningLeftColumn.mode === \'3days\')">Férié</span></div><div class=days-body ng-switch-when=week><div class="dayName row8 b-b animate" ng-repeat="day in planningLeftColumn.days track by $index" ng-class="{today: (planning.isToday(day.dayOfYear())), isFerie: planning.isFerie(day)}" ng-click=planning.dayCallback({$day:day})><h4>{{day | format:\'dddd\' | capitalize}}<br><small>{{day | format:\'ll\'}}<span class=holidays ng-if=planning.isFerie(day)>férié</span></small></h4><div ng-click=$event.stopPropagation() class=day-absence ng-if=planningLeftColumn._absences[$index].length><div class=absents-container ng-click="planning.showAbsencesCallBackWrapper(planningLeftColumn._absences, $index)">{{ planningLeftColumn._absences[$index].length }} absent(s)</div></div></div></div><div class=days-body ng-switch-when=day><div class="dayName row8 b-b animate" ng-repeat="tech in planningLeftColumn.column"><h4>{{tech.fullname || \'\'}}</h4></div></div></div><div style=height:10px></div></div>'),e.put("/directives/planning-week-line/planning-week-line.html","<div class=week-line ng-class=\"'week-' + line.week\" style=padding-top:20px;><div class=single-day-events style=\"height:40%; position:relative;\"><div zl-planning-drag-drop zl-drag=ev ng-repeat=\"ev in line.oneDayEvents\" ng-style=\"{'top': ev.style.top, 'height': ev.style.height, 'background-color': ev.style['background-color'], 'color' : ev.style.color, 'width': ev.style.width, 'left': ev.style.left}\" style=\"position:absolute;border: 1px solid black;pointer-events: auto; overflow: hidden;\" ng-click=\"planning.weekEventCallback({event: ev})\" tooltip-append-to-body=true tooltip-placement=\"{{ev.tooltipTemplate? 'auto': 'top'}}\" ng-attr-uib-tooltip=\"{{!ev.tooltipTemplate ? ev.tooltip : undefined}}\" ng-attr-uib-tooltip-template=\"{{'' + ev.tooltipTemplate}}\" tooltip-class=planning-event-tooltip class=single-day-event><div class=event-line-container><div class=event-line ng-style=\"{'background-color': ev.color}\" ng-if=!ev.continuedBefore></div></div><div class=single-day-event-title data-context-menu=/templates/planning-context-menu.html><span>{{ev.title}}</span></div></div></div><div class=multiple-days-events style=\"height:40%; position: relative;\"><div class=multiple-day-event ng-repeat=\"event in line.displayedEvents\" style=\"position: absolute; border: 1px solid black;pointer-events: auto; overflow: hidden;\" zl-planning-drag-drop zl-drag=event ng-click=\"planning.weekEventCallback({event: event})\" tooltip-append-to-body=true tooltip-placement=\"{{event.tooltipTemplate? 'auto': 'top'}}\" ng-attr-uib-tooltip=\"{{!event.tooltipTemplate ? event.tooltip : undefined}}\" ng-attr-uib-tooltip-template=\"{{'' + event.tooltipTemplate}}\" tooltip-class=planning-event-tooltip ng-style=\"{'top': event.style.top, 'height': event.style.height, 'background-color': event.style['background-color'], 'color' : event.style.color, 'width': event.style.width, 'left': event.style.left}\"><div class=event-line-container><div class=event-line ng-style=\"{'background-color': event.color}\" ng-if=!event.continuedBefore></div></div><div class=multiple-day-event-title data-context-menu=/templates/planning-context-menu.html><span>{{event.title}}</span></div></div></div></div>")}]);
//# sourceMappingURL=planning.js.map
